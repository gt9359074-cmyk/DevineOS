<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DivineOS // Injector_Mode_v9.1_UNLOCKS</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
    /* --- SYSTEM AESTHETICS --- */
    :root {
        --bg: #0000AA;
        --win: #FFFFFF;
        --text: #000000;
        --accent: #AA0000;
        --highlight: #00AAAA;
        --dim: #AAAAAA;
    }
    * { box-sizing: border-box; user-select: none; }
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        overflow: hidden; font-family: 'Courier New', monospace;
        background-color: #000; color: var(--text); cursor: crosshair; font-weight: bold;
        transition: background 0.3s;
    }

    /* BIOS SCREEN */
    #bios-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; padding: 20px; z-index: 999999;
        display: flex; flex-direction: column; justify-content: flex-start;
        font-size: 14px; line-height: 1.5; overflow: hidden;
    }
    .log-line { display: block; animation: fadein 0.1s; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

    /* BSOD */
    #bsod {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000088; color: white; padding: 50px; z-index: 1000000;
        font-family: 'Courier New', monospace;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }

    /* DESKTOP */
    #desktop {
        width: 100%; height: calc(100% - 40px); position: relative;
        background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        background-color: var(--bg);
        display: none; overflow: hidden;
    }
    #desktop.drag-over { background-color: rgba(255,255,255,0.2); }

    /* IMMERSIVE NOTIFICATIONS (TOASTS) */
    #toast-container {
        position: absolute; top: 10px; right: 10px;
        width: 300px; display: flex; flex-direction: column; gap: 5px;
        z-index: 999999; pointer-events: none;
    }
    .toast {
        background: rgba(0,0,0,0.9); color: #0f0; 
        border: 1px solid #0f0; padding: 10px; 
        font-size: 12px; font-family: 'Courier New';
        box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
        animation: slideIn 0.3s forwards;
        pointer-events: auto;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* ICONS */
    .desktop-icon {
        position: absolute; width: 90px; height: 90px;
        text-align: center; color: white; cursor: pointer;
        padding: 5px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; z-index: 10;
        border: 1px dotted transparent;
        text-shadow: 1px 1px 0 #000;
    }
    .icon-img { 
        font-size: 32px; margin-bottom: 5px; width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
        border: 4px double rgba(255,255,255,0.5); border-radius: 4px;
        box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        transition: transform 0.1s, filter 0.1s;
    }
    .desktop-icon:hover .icon-img { transform: translateY(-2px); filter: brightness(1.2); border-color: white; }
    .icon-label { font-size: 12px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 2px; }
    .desktop-icon:hover .icon-label { background: black; }

    /* WINDOWS */
    .window {
        position: absolute; background: var(--win); color: var(--text);
        border: 4px double var(--accent);
        box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
        display: flex; flex-direction: column;
        min-width: 200px; min-height: 150px;
    }
    .title-bar {
        background: var(--accent); color: #FFFF55;
        padding: 5px; display: flex; justify-content: space-between;
        align-items: center; cursor: grab; border-bottom: 2px solid black;
        font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
        flex-shrink: 0;
    }
    .close-btn {
        background: var(--highlight); color: white; border: 1px solid black;
        width: 20px; height: 20px; text-align: center; line-height: 16px;
        cursor: pointer;
    }
    .close-btn:hover { background: white; color: black; }
    .content { flex-grow: 1; overflow: auto; position: relative; }
    .resize-handle {
        width: 15px; height: 15px; background: var(--accent);
        position: absolute; bottom: 0; right: 0; cursor: nwse-resize;
        z-index: 10; clip-path: polygon(100% 0, 100% 100%, 0 100%);
    }

    /* TASKBAR */
    #taskbar {
        position: absolute; bottom: 0; left: 0;
        width: 100%; height: 40px; background: var(--dim);
        border-top: 4px solid white; display: none; align-items: center;
        padding: 0 10px; z-index: 9999;
    }
    #start-btn {
        background: var(--highlight); color: white; border: 3px outset white;
        padding: 5px 15px; font-weight: bold; margin-right: 15px; cursor: pointer;
    }
    #reboot-btn {
        background: red; color: white; border: 3px outset white;
        padding: 5px 10px; font-weight: bold; margin-right: 15px; cursor: pointer;
        font-size: 10px;
    }
    .task-tab {
        background: white; border: 2px solid black; padding: 5px 10px;
        margin-right: 5px; cursor: pointer; font-size: 12px;
        box-shadow: 3px 3px 0px #555;
        color: black;
    }

    /* APP UI */
    .file-list { padding: 10px; }
    .file-row { display: flex; align-items: center; padding: 5px; border-bottom: 1px dotted #ccc; }
    .file-row:hover { background: #eee; }
    .f-icon { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; cursor: pointer; }
    .f-name { flex-grow: 1; font-size: 14px; cursor: pointer; }
    .f-btn { 
        border: 1px solid black; background: #ddd; 
        font-size: 10px; padding: 2px 5px; margin-left: 5px; 
        cursor: pointer; font-family: 'Courier New'; font-weight: bold;
    }
    .f-btn:hover { background: black; color: white; }
    .f-btn.del { color: red; }
    .f-btn.exp { color: white; background: blue; border-color: darkblue; }
    .f-btn.exp:hover { background: cyan; color: black; }
    textarea { font-family: 'Courier New'; font-weight: bold; }
</style>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

<div id="bios-screen">
    <div>DIVINE BIOS v9.1 (SECURE_BOOT)</div>
    <div id="bios-status-line">System Status...</div>
    <br>
    <div id="boot-log"></div>
    
    <div id="auth-ui" style="display:none; margin-top:20px; border:1px solid white; padding:20px;">
        <p id="auth-msg">SECURE BOOT</p>
        <input type="password" id="boot-pass" placeholder="ENTER KEY" style="background:black; color:white; border:none; border-bottom:2px solid white; font-family:monospace; font-size:18px; text-align:center; width:100%;">
        <br><br>
        <button onclick="BIO.unlockSystem()" style="background:white; color:black; font-weight:bold; padding:5px 20px; cursor:pointer;">PROCEED</button>
    </div>

    <div style="margin-top:auto; color:red; border-top:1px solid red; padding-top:5px;">
        [F8] EMERGENCY: <button onclick="BIO.factoryReset()">FACTORY RESET (WIPE DISK)</button>
    </div>
</div>

<div id="bsod">
    <h1 style="background: white; color: blue; padding: 5px;">FATAL SYSTEM ERROR</h1>
    <button onclick="BIO.factoryReset()" style="padding:10px; font-weight:bold; color:red;">FACTORY RESET</button>
</div>

<div id="desktop">
    <div id="toast-container"></div>
</div>

<div id="taskbar">
    <button id="start-btn" onclick="BIO.runScript('/core/manifest.js')">SYSTEM</button>
    <button id="reboot-btn" onclick="BIO.reboot()">‚ü≥ REBOOT</button>
    <div id="task-list" style="display: flex;"></div>
    <div style="margin-left: auto; color: blue;" id="clock">00:00</div>
</div>

<script>
/* ----------------------------------------------------
   THE BIOS (Basic Input/Output System)
   ----------------------------------------------------
*/
const BIO = {
    zIndex: 100,
    fs: null, 
    masterKey: null, // Holds password in RAM
    
    // DEFAULT FS (CLEAN STATE)
    defaultFS: {
        root: {
            home: { 
                type: 'dir', 
                content: {
                    public: { type: 'dir', content: {} } // PUBLIC FOLDER FOR MESH
                } 
            },
            var: { type: 'dir', content: { 
                "sys.log": { type: 'file', content: "--- SYSTEM LOG STARTED ---\n" } 
            }},
            www: {
                type: 'dir',
                content: {
                    "index.html": { type: 'file', content: `<h1>WELCOME TO DIVINE NET</h1><p>Local Secure Intranet.</p><hr><ul><li><a href="bookmarks.html">>> OPEN BOOKMARKS <<</a></li><li><a href="about.html">System Info</a></li><li><a href="contact.html">Contact Root</a></li></ul>` },
                    "bookmarks.html": { type: 'file', content: `<style>body{font-family:monospace;padding:10px;} .warn{background:#ffcccc;border:2px solid red;padding:10px;margin-bottom:20px;color:red;font-weight:bold;}</style><h1>NEXUS GATEWAY</h1><div class="warn">‚ö† SEARCH PRIVACY: URLs typed in the bar above are private. Google searches inside the frame are logged by Google.</div><h3>COMPATIBLE SITES</h3><ul><li><a href="https://www.google.com/webhp?igu=1">Google (Unblocked Mode)</a></li><li><a href="https://www.wikipedia.org">Wikipedia</a></li><li><a href="https://yewtu.be">Invidious (YouTube Alt)</a></li><li><a href="https://web.archive.org">Wayback Machine</a></li></ul><hr><a href="index.html">Back to Local Index</a>` },
                    "about.html": { type: 'file', content: `<h1>ABOUT</h1><p>DivineOS is a Javascript based environment running in local RAM.</p><a href="index.html">Back</a>` },
                    "contact.html": { type: 'file', content: `<h1>CONTACT</h1><p>Admin: ROOT_USER</p><a href="index.html">Back</a>` }
                }
            },
            system: {
                type: 'dir',
                content: {
                    "config.json": { type: 'file', content: `{\n    "theme": {\n        "--bg": "#0000AA",\n        "--win": "#FFFFFF",\n        "--text": "#000000",\n        "--accent": "#AA0000",\n        "--highlight": "#00AAAA",\n        "--dim": "#AAAAAA"\n    },\n    "system": { "clockFormat": "local", "username": "TESTER" }\n}` },
                    "kernel.js": { type: 'file', content: `
window.Kernel = {
    activeWindows: {},
    createWindow: function(title, w, h, html, id) {
        if (!BIO.resolve('/system/kernel.js')) { BIO.crash("KERNEL_NOT_FOUND_ON_DISK"); return; }
        BIO.applyTheme(); 
        if(id && document.getElementById(id)) return;
        const winId = id || 'win-'+Math.random().toString(36).substr(2,5);
        const win = document.createElement('div');
        win.className = 'window'; win.id = winId;
        win.style.width = w+'px'; win.style.height = h+'px';
        win.style.left = (150 + (BIO.zIndex%10)*30)+'px';
        win.style.top = (50 + (BIO.zIndex%10)*30)+'px';
        win.style.zIndex = ++BIO.zIndex;
        
        const bar = document.createElement('div');
        bar.className = 'title-bar';
        bar.innerHTML = '<span>'+title+'</span> <div class="close-btn" onclick="Kernel.closeWindow(\\''+winId+'\\')">X</div>';
        
        const cont = document.createElement('div');
        cont.className = 'content'; cont.innerHTML = html;
        const resize = document.createElement('div');
        resize.className = 'resize-handle';
        
        win.appendChild(bar); win.appendChild(cont); win.appendChild(resize);
        document.getElementById('desktop').appendChild(win);
        Kernel.makeDraggable(win, bar); Kernel.makeResizable(win, resize);
        
        const tab = document.createElement('div');
        tab.className = 'task-tab'; tab.id = 'tab-'+winId; tab.innerText = title;
        tab.onclick = function(){ win.style.display='flex'; win.style.zIndex=++BIO.zIndex; };
        document.getElementById('task-list').appendChild(tab);
        Kernel.activeWindows[winId] = title;
    },
    closeWindow: function(id) {
        const w = document.getElementById(id); if(w) w.remove();
        const t = document.getElementById('tab-'+id); if(t) t.remove();
        delete Kernel.activeWindows[id];
    },
    makeDraggable: function(elm, handle) {
        let pos1=0, pos2=0, pos3=0, pos4=0;
        handle.onmousedown = function(e) {
            if(e.target.className === 'close-btn') return;
            e.preventDefault(); pos3=e.clientX; pos4=e.clientY;
            document.onmouseup = function() { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = function(e) {
                e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY;
                elm.style.top = (elm.offsetTop - pos2) + "px"; elm.style.left = (elm.offsetLeft - pos1) + "px";
            };
        };
        elm.onmousedown = function() { elm.style.zIndex = ++BIO.zIndex; }
    },
    makeResizable: function(elm, handle) {
        handle.onmousedown = function(e) {
            e.preventDefault(); e.stopPropagation();
            const startX = e.clientX; const startY = e.clientY;
            const startW = parseInt(document.defaultView.getComputedStyle(elm).width, 10);
            const startH = parseInt(document.defaultView.getComputedStyle(elm).height, 10);
            document.onmouseup = function() { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = function(e) {
                elm.style.width = (startW + e.clientX - startX) + 'px'; elm.style.height = (startH + e.clientY - startY) + 'px';
            };
        };
    }
};` 
                    },
                    "boot.js": { type: 'file', content: `
/* --- BOOT SEQUENCE --- */
BIO.applyTheme();
BIO.sysLog("BOOT: System Loaded from LocalStorage.");

const icons = [
    {name: 'TERMINAL', icon: 'üíª', run: '/core/terminal.js', x:0, y:0, color:'#000000'},
    {name: 'MANIFEST', icon: 'üìÇ', run: '/core/manifest.js', x:0, y:1, color:'#AA8800'}, 
    {name: 'SETTINGS', icon: '‚öôÔ∏è', run: '/core/config_editor.js', x:0, y:2, color:'#555555'},
    {name: 'TASKMGR',  icon: 'üìä', run: '/core/taskmgr.js',  x:0, y:3, color:'#005500'},

    {name: 'SCRIBE',   icon: 'üìù', run: '/core/notepad.js', x:1, y:0, color:'#0000AA'}, 
    {name: 'PRISM',    icon: 'üíé', run: '/core/prism.js',   x:1, y:1, color:'#8800FF'}, 
    {name: 'CANVAS',   icon: 'üé®', run: '/core/paint.js',   x:1, y:2, color:'#AA00AA'}, 
    {name: 'ABACUS',   icon: 'üßÆ', run: '/core/calc.js',    x:1, y:3, color:'#555555'},

    {name: 'SYNTH',    icon: 'üéπ', run: '/core/synth.js',   x:2, y:0, color:'#333333'},
    {name: 'SERPENT',  icon: 'üêç', run: '/core/snake.js',   x:2, y:1, color:'#00AA00'}, 
    {name: 'MINES',    icon: 'üí£', run: '/core/mines.js',   x:2, y:2, color:'#AA0000'}, 
    {name: 'CHRONOS',  icon: '‚è±Ô∏è', run: '/core/chronos.js', x:2, y:3, color:'#00AAAA'}, 

    {name: 'NEXUS',    icon: 'üåç', run: '/core/nexus.js',    x:3, y:0, color:'#0000FF'},
    {name: 'SIGNAL',   icon: 'üì°', run: '/core/signal.js',   x:3, y:1, color:'#FF4400'},
    {name: 'MESH',     icon: 'üï∏Ô∏è', run: '/core/mesh.js',     x:3, y:2, color:'#3333FF'}
];

// --- DYNAMIC UNLOCK SYSTEM ---
// The following icons only appear if unlocked via Terminal
if(BIO.resolve('/system/injector.flag')) {
    icons.push({name: 'INJECTOR', icon: 'üíâ', run: '/core/injector.js', x:4, y:3, color:'#CC0000'});
}
if(BIO.resolve('/system/bluescan.flag')) {
    icons.push({name: 'BLUESCAN', icon: 'üì°', run: '/core/bluescan.js', x:4, y:0, color:'#000088'});
}
if(BIO.resolve('/system/subspace.flag')) {
    icons.push({name: 'SUBSPACE', icon: 'üõ∞Ô∏è', run: '/core/subspace.js', x:4, y:1, color:'#005500'});
}
if(BIO.resolve('/system/identity.flag')) {
    icons.push({name: 'IDENTITY', icon: 'üëÅÔ∏è', run: '/core/identity.js', x:4, y:2, color:'#AA0000'});
}

icons.forEach(i => {
    const d = document.createElement('div');
    d.className = 'desktop-icon';
    d.style.left = (20 + i.x*100) + 'px';
    d.style.top = (20 + i.y*100) + 'px';
    d.innerHTML = '<span class="icon-img" style="background-color:'+i.color+'">'+i.icon+'</span><span class="icon-label">'+i.name+'</span>';
    d.onmousedown = function(e) {
        if(!window.Kernel) return; 
        BIO.runScript(i.run); 
    };
    document.getElementById('desktop').appendChild(d);
});
BIO.runScript('/core/terminal.js');` 
                    }
                }
            },
            core: {
                type: 'dir',
                content: {
                    // --- NEW APP 1: BLUESCAN ---
                    "bluescan.js": { type: 'file', content: `
const html = '<div style="background:#001133;color:#00ffff;padding:10px;height:100%;display:flex;flex-direction:column;font-family:monospace;">' +
'<div style="border:1px solid #00ffff;padding:5px;text-align:center;">BLUETOOTH RADAR</div>' +
'<button onclick="BlueScan.scan()" style="margin:10px;background:#00ffff;color:black;font-weight:bold;padding:10px;cursor:pointer;">INITIATE SCAN</button>' +
'<div id="bs-log" style="flex:1;overflow:auto;border:1px dashed #005555;padding:5px;">Waiting for signal...</div></div>';
window.BlueScan = {
    scan: function() {
        const log = document.getElementById('bs-log');
        log.innerHTML += '<div>Scanning airwaves...</div>';
        if (!navigator.bluetooth) { log.innerHTML += '<div style="color:red">BLUETOOTH API NOT SUPPORTED</div>'; return; }
        navigator.bluetooth.requestDevice({ acceptAllDevices: true })
        .then(device => {
            log.innerHTML += '<div style="color:#0f0;margin-top:5px;">[FOUND] ' + (device.name || 'Unknown Device') + '</div>';
            log.innerHTML += '<div style="color:#aaa;font-size:10px;">ID: ' + device.id + '</div>';
            log.innerHTML += '<div style="color:#aaa;font-size:10px;">CONNECTED: ' + device.gatt.connected + '</div>';
        })
        .catch(error => { log.innerHTML += '<div style="color:red;">SCAN ABORTED: ' + error + '</div>'; });
    }
};
Kernel.createWindow('BLUESCAN', 350, 400, html, 'win-blue');
` },
                    // --- NEW APP 2: SUBSPACE ---
                    "subspace.js": { type: 'file', content: `
const html = '<div style="background:black;color:#00ff00;padding:10px;height:100%;font-family:monospace;display:flex;flex-direction:column;">' +
'<div style="border-bottom:1px solid #00ff00;margin-bottom:10px;">SUBSPACE NETWORK MAPPER</div>' +
'<div id="ss-grid" style="flex:1;overflow:auto;"></div>' +
'<button onclick="Subspace.pingAll()" style="background:#003300;color:#00ff00;border:1px solid #00ff00;padding:5px;cursor:pointer;">START SWEEP</button></div>';
window.Subspace = {
    targets: ['192.168.0.1','192.168.1.1','192.168.1.254','10.0.0.1','10.0.0.138','172.16.0.1','127.0.0.1'],
    pingAll: function() {
        const grid = document.getElementById('ss-grid');
        grid.innerHTML = '<div>Initializing Ping Sequence...</div>';
        Subspace.targets.forEach(ip => {
            const row = document.createElement('div');
            row.innerText = 'PING > ' + ip + ' ...';
            grid.appendChild(row);
            const start = Date.now();
            fetch('http://'+ip, { mode: 'no-cors', signal: AbortSignal.timeout(1500) })
            .then(() => { 
                row.innerHTML = '<span style="color:#0f0">[ALIVE]</span> ' + ip + ' (' + (Date.now()-start) + 'ms)';
            })
            .catch(e => {
                if(e.name === 'AbortError') row.innerHTML = '<span style="color:#555">[DEAD]</span> ' + ip;
                else row.innerHTML = '<span style="color:#0f0">[ALIVE]</span> ' + ip + ' (Refused)';
            });
        });
    }
};
Kernel.createWindow('SUBSPACE', 400, 450, html, 'win-sub');
` },
                    // --- NEW APP 3: IDENTITY ---
                    "identity.js": { type: 'file', content: `
const html = '<div style="background:#220000;color:#ff5555;padding:10px;height:100%;font-family:monospace;">' +
'<div style="text-align:center;font-size:20px;border-bottom:2px solid red;">IDENTITY AUDIT</div>' +
'<div id="id-data" style="margin-top:10px;">Loading...</div></div>';
window.Identity = {
    init: function() {
        const d = document.getElementById('id-data');
        let txt = '';
        txt += '<div>USER_AGENT: <span style="color:white">' + navigator.userAgent + '</span></div><hr>';
        txt += '<div>CPU CORES: <span style="color:white">' + (navigator.hardwareConcurrency || '?') + '</span></div>';
        txt += '<div>RAM (Est): <span style="color:white">' + (navigator.deviceMemory || '?') + ' GB</span></div>';
        txt += '<div>PLATFORM: <span style="color:white">' + navigator.platform + '</span></div>';
        txt += '<div>LANGUAGE: <span style="color:white">' + navigator.language + '</span></div>';
        txt += '<div>ONLINE: <span style="color:white">' + navigator.onLine + '</span></div>';
        
        if(navigator.getBattery) {
            navigator.getBattery().then(b => {
                const batt = '<div>BATTERY: <span style="color:white">' + (b.level*100) + '% ' + (b.charging?'[CHARGING]':'[DRAINING]') + '</span></div>';
                d.innerHTML += batt;
            });
        }
        d.innerHTML = txt;
    }
};
Kernel.createWindow('IDENTITY', 400, 500, html, 'win-id');
Identity.init();
` },
                    // --- INJECTOR (HIDDEN APP) ---
                    "injector.js": {
                        type: 'file',
                        content: `
/* --- DOM INJECTOR (SYSTEM OVERRIDE) --- */
const html = \`<div style="padding:10px; background:#111; color:#0f0; height:100%; font-family:monospace; display:flex; flex-direction:column;">
    <div style="border-bottom:1px solid #0f0; padding-bottom:5px; margin-bottom:10px; font-weight:bold;">ROOT ACCESS // DOM OVERRIDE</div>
    <div style="flex:1; overflow:auto;">
        <div style="margin-bottom:10px;">
            <label>BACKGROUND COLOR (--bg)</label>
            <input type="color" id="inj-bg" style="width:100%; height:30px; cursor:pointer;" oninput="Injector.update('--bg', this.value)">
        </div>
        <div style="margin-bottom:10px;">
            <label>WINDOW BACKGROUND (--win)</label>
            <input type="color" id="inj-win" style="width:100%; height:30px; cursor:pointer;" oninput="Injector.update('--win', this.value)">
        </div>
        <div style="margin-bottom:10px;">
            <label>ACCENT COLOR (--accent)</label>
            <input type="color" id="inj-acc" style="width:100%; height:30px; cursor:pointer;" oninput="Injector.update('--accent', this.value)">
        </div>
        <div style="margin-bottom:10px;">
            <label>TEXT COLOR (--text)</label>
            <input type="color" id="inj-txt" style="width:100%; height:30px; cursor:pointer;" oninput="Injector.update('--text', this.value)">
        </div>
        <div style="margin-bottom:10px;">
            <label>HIGHLIGHT COLOR (--highlight)</label>
            <input type="color" id="inj-high" style="width:100%; height:30px; cursor:pointer;" oninput="Injector.update('--highlight', this.value)">
        </div>
    </div>
    <button onclick="Injector.save()" style="padding:10px; background:#005500; color:white; border:2px solid #0f0; font-weight:bold; cursor:pointer; margin-top:10px;">SAVE CONFIGURATION</button>
</div>\`;

window.Injector = {
    update: function(key, val) {
        document.documentElement.style.setProperty(key, val);
    },
    save: function() {
        const file = BIO.resolve('/system/config.json');
        if(file) {
            try {
                const cfg = JSON.parse(file.content);
                cfg.theme['--bg'] = document.getElementById('inj-bg').value;
                cfg.theme['--win'] = document.getElementById('inj-win').value;
                cfg.theme['--accent'] = document.getElementById('inj-acc').value;
                cfg.theme['--text'] = document.getElementById('inj-txt').value;
                cfg.theme['--highlight'] = document.getElementById('inj-high').value;
                BIO.saveFile('/system/config.json', JSON.stringify(cfg));
                BIO.toast("SYSTEM OVERRIDE SAVED.");
            } catch(e) { BIO.toast("CONFIG ERROR"); }
        }
    },
    init: function() {
        // Load current values
        const s = getComputedStyle(document.documentElement);
        document.getElementById('inj-bg').value = s.getPropertyValue('--bg').trim();
        document.getElementById('inj-win').value = s.getPropertyValue('--win').trim();
        document.getElementById('inj-acc').value = s.getPropertyValue('--accent').trim();
        document.getElementById('inj-txt').value = s.getPropertyValue('--text').trim();
        document.getElementById('inj-high').value = s.getPropertyValue('--highlight').trim();
    }
};

Kernel.createWindow('INJECTOR', 300, 450, html, 'win-injector');
Injector.init();
`
                    },
                    // --- MESH (NETWORK DRIVE) APP ---
                    "mesh.js": {
                        type: 'file',
                        content: `
/* --- THE MESH (P2P File System) --- */
const html = '<div style="display:flex; flex-direction:column; height:100%; font-family:monospace;">' +
    '<div style="background:#222; color:#0f0; padding:10px; border-bottom:2px solid #0f0; display:flex; gap:10px;">' +
        '<span>ID: <span id="mesh-id" style="color:white;">...</span></span>' +
        '<input id="mesh-target" placeholder="Peer ID" style="flex:1; background:black; color:white; border:1px solid #555;">' +
        '<button onclick="Mesh.connect()">CONNECT</button>' +
    '</div>' +
    '<div style="flex:1; display:flex; background:black;">' +
        '<div style="flex:1; border-right:2px solid #555; display:flex; flex-direction:column;">' +
            '<div style="background:#0000AA; color:white; padding:5px; text-align:center;">LOCAL (/home/public)</div>' +
            '<div id="mesh-local" style="flex:1; overflow:auto; padding:5px; color:white;"></div>' +
            '<button onclick="Mesh.refreshLocal()" style="background:#444; color:white;">REFRESH LOCAL</button>' +
        '</div>' +
        '<div style="flex:1; display:flex; flex-direction:column;">' +
            '<div style="background:#AA0000; color:white; padding:5px; text-align:center;">REMOTE DRIVE</div>' +
            '<div id="mesh-remote" style="flex:1; overflow:auto; padding:5px; color:#ccc;">NOT CONNECTED</div>' +
            '<button onclick="Mesh.requestList()" style="background:#444; color:white;">REFRESH REMOTE</button>' +
        '</div>' +
    '</div>' +
    '<div id="mesh-log" style="height:30px; background:#111; color:gray; padding:5px; font-size:12px; border-top:1px solid #555;">Ready.</div>' +
'</div>';

window.Mesh = {
    peer: null, conn: null,
    
    init: function() {
        if(!BIO.resolve('/home/public')) {
            BIO.saveFile('/home/public/readme.txt', 'Put files here to share via Mesh.');
        }
        
        let user = localStorage.getItem('divineOS_signal_user');
        if(!user) user = 'anon_' + Math.floor(Math.random()*1000);
        const meshId = user + '_net';
        
        Mesh.peer = new Peer(meshId);
        
        Mesh.peer.on('open', (id) => {
            document.getElementById('mesh-id').innerText = id;
            Mesh.log("Mesh Node Active: " + id);
            Mesh.refreshLocal();
        });
        
        Mesh.peer.on('connection', (c) => {
            Mesh.conn = c;
            Mesh.setupConn();
            Mesh.log("Incoming connection from " + c.peer);
        });
        
        Mesh.peer.on('error', (e) => Mesh.log("Error: " + e.type));
    },
    
    connect: function() {
        const target = document.getElementById('mesh-target').value.trim();
        if(!target) return;
        Mesh.log("Connecting to " + target + "...");
        Mesh.conn = Mesh.peer.connect(target);
        Mesh.setupConn();
    },
    
    setupConn: function() {
        Mesh.conn.on('open', () => {
            Mesh.log("Connected to " + Mesh.conn.peer);
            document.getElementById('mesh-remote').innerHTML = '<div style="text-align:center; padding:20px;">ACCESS GRANTED<br>Loading...</div>';
            Mesh.requestList();
        });
        
        Mesh.conn.on('data', (data) => {
            if(data.type === 'list_req') {
                const dir = BIO.resolve('/home/public');
                const list = dir ? Object.keys(dir) : [];
                Mesh.conn.send({type: 'list_res', list: list});
            }
            else if(data.type === 'list_res') {
                Mesh.renderRemote(data.list);
            }
            else if(data.type === 'get_file') {
                const file = BIO.resolve('/home/public/' + data.name);
                if(file) Mesh.conn.send({type: 'file_data', name: data.name, content: file.content});
            }
            else if(data.type === 'file_data') {
                BIO.saveFile('/home/public/' + data.name, data.content);
                Mesh.log("Downloaded: " + data.name);
                Mesh.refreshLocal();
            }
            else if(data.type === 'upload_file') {
                BIO.saveFile('/home/public/' + data.name, data.content);
                Mesh.log("Received Upload: " + data.name);
                Mesh.refreshLocal();
            }
        });
        
        Mesh.conn.on('close', () => {
            Mesh.log("Connection Lost");
            document.getElementById('mesh-remote').innerHTML = 'DISCONNECTED';
        });
    },
    
    refreshLocal: function() {
        const div = document.getElementById('mesh-local');
        div.innerHTML = '';
        const dir = BIO.resolve('/home/public');
        if(!dir) return;
        for(let key in dir) {
            const row = document.createElement('div');
            row.style.borderBottom = '1px dotted #555';
            row.style.cursor = 'pointer';
            row.style.padding = '2px';
            row.innerText = 'üìÑ ' + key;
            row.onclick = () => {
                if(Mesh.conn && confirm("UPLOAD " + key + " to Remote Peer?")) {
                    const f = BIO.resolve('/home/public/' + key);
                    Mesh.conn.send({type: 'upload_file', name: key, content: f.content});
                    Mesh.log("Uploading...");
                }
            };
            row.onmouseover = function(){ this.style.background = '#333'; }
            row.onmouseout = function(){ this.style.background = 'transparent'; }
            div.appendChild(row);
        }
    },
    
    requestList: function() {
        if(Mesh.conn) Mesh.conn.send({type: 'list_req'});
    },
    
    renderRemote: function(list) {
        const div = document.getElementById('mesh-remote');
        div.innerHTML = '';
        list.forEach(key => {
            const row = document.createElement('div');
            row.style.borderBottom = '1px dotted #555';
            row.style.cursor = 'pointer';
            row.style.padding = '2px';
            row.innerText = 'üìÑ ' + key;
            row.onclick = () => {
                if(confirm("DOWNLOAD " + key + " to local drive?")) {
                    Mesh.conn.send({type: 'get_file', name: key});
                    Mesh.log("Requesting " + key + "...");
                }
            };
            row.onmouseover = function(){ this.style.background = '#550000'; }
            row.onmouseout = function(){ this.style.background = 'transparent'; }
            div.appendChild(row);
        });
    },
    
    log: function(msg) {
        document.getElementById('mesh-log').innerText = "> " + msg;
    }
};

Kernel.createWindow('MESH DRIVE', 600, 400, html, 'win-mesh');
setTimeout(Mesh.init, 100);
`
                    },
                    "signal.js": {
                        type: 'file',
                        content: `
/* --- SIGNAL MESSENGER v2.2 (No Alerts) --- */
const html = '<div style="display:flex; height:100%; font-family:monospace; background:#111;">' +
    '<div style="width:140px; background:#222; border-right:1px solid #444; display:flex; flex-direction:column;">' +
        '<div style="padding:5px; border-bottom:1px solid #444; color:#fff; font-weight:bold; text-align:center;">CONTACTS</div>' +
        '<div id="sig-contacts" style="flex:1; overflow:auto;"></div>' +
        '<div id="sig-add-ui" style="display:none; padding:5px; background:#333;">' +
            '<input id="sig-add-inp" style="width:100%;" placeholder="Name">' +
            '<button onclick="Signal.confirmAdd()">OK</button>' +
        '</div>' +
        '<button onclick="Signal.showAdd()" style="background:#005500; color:white; border:none; padding:5px; cursor:pointer;">+ ADD USER</button>' +
    '</div>' +
    '<div style="flex:1; display:flex; flex-direction:column;">' +
        '<div id="sig-login" style="padding:20px; text-align:center; color:#0f0;">' +
            '<div>LOG IN TO SIGNAL</div><br>' +
            '<input id="sig-user" placeholder="Create Username" style="background:black; color:white; border:1px solid #0f0; padding:5px;">' +
            '<button onclick="Signal.login()">GO</button>' +
        '</div>' +
        '<div id="sig-chat" style="display:none; flex-direction:column; height:100%;">' +
            '<div style="padding:5px; background:#333; color:#fff; border-bottom:1px solid #000; display:flex; justify-content:space-between; align-items:center;">' +
                '<span>ID: <span id="sig-myid" style="color:#0f0;">...</span></span>' +
                '<button onclick="Signal.logout()" style="font-size:10px; background:red; color:white; border:none; cursor:pointer;">LOGOUT</button>' +
            '</div>' +
            '<div id="sig-log" style="flex:1; overflow:auto; padding:10px; color:#ccc;"></div>' +
            '<div style="display:flex; padding:5px; background:#222;">' +
                '<input id="sig-msg" style="flex:1; background:black; color:white; border:1px solid #555;" placeholder="Message..." onkeydown="if(event.key===\\\'Enter\\\')Signal.send()">' +
                '<button onclick="Signal.send()">SEND</button>' +
            '</div>' +
        '</div>' +
    '</div>' +
    '</div>';

window.Signal = {
    peer: null, conn: null, contacts: [],
    
    init: function() {
        const saved = localStorage.getItem('divineOS_signal_contacts');
        if(saved) Signal.contacts = JSON.parse(saved);
        Signal.renderContacts();
        
        const lastUser = localStorage.getItem('divineOS_signal_user');
        if(lastUser) {
            document.getElementById('sig-user').value = lastUser;
            Signal.login(); 
        }
    },
    
    login: function() {
        const user = document.getElementById('sig-user').value.trim();
        if(!user) return BIO.toast("Enter a username");
        localStorage.setItem('divineOS_signal_user', user);
        document.getElementById('sig-login').innerHTML = '<div style="margin-top:50px;">LOGGING IN AS '+user+'...</div>';
        
        Signal.peer = new Peer(user);
        
        Signal.peer.on('open', (id) => {
            document.getElementById('sig-login').style.display = 'none';
            document.getElementById('sig-chat').style.display = 'flex';
            document.getElementById('sig-myid').innerText = id;
            BIO.toast("SIGNAL: Online");
        });
        
        Signal.peer.on('error', (err) => {
            if(err.type === 'unavailable-id') {
                BIO.toast("ID Taken. Resetting...");
                localStorage.removeItem('divineOS_signal_user');
                setTimeout(() => { Kernel.closeWindow('win-signal'); BIO.runScript('/core/signal.js'); }, 1000);
            }
            else BIO.toast("Net Error: " + err.type);
        });
        
        Signal.peer.on('connection', (c) => {
            Signal.conn = c;
            Signal.setupConn();
            BIO.toast("Incoming Connection...");
            Signal.log("<i>Incoming connection...</i>");
        });
    },
    
    logout: function() {
        localStorage.removeItem('divineOS_signal_user');
        if(Signal.peer) Signal.peer.destroy();
        Kernel.closeWindow('win-signal');
        BIO.runScript('/core/signal.js'); 
    },
    
    showAdd: function() { document.getElementById('sig-add-ui').style.display = 'block'; },
    confirmAdd: function() {
        const name = document.getElementById('sig-add-inp').value;
        if(name) {
            Signal.contacts.push(name);
            localStorage.setItem('divineOS_signal_contacts', JSON.stringify(Signal.contacts));
            Signal.renderContacts();
        }
        document.getElementById('sig-add-ui').style.display = 'none';
    },
    
    renderContacts: function() {
        const list = document.getElementById('sig-contacts');
        if(!list) return;
        list.innerHTML = '';
        Signal.contacts.forEach(c => {
            const div = document.createElement('div');
            div.style.padding = '5px'; div.style.cursor = 'pointer'; div.style.color = '#ccc';
            div.style.borderBottom = '1px solid #333';
            div.innerText = c;
            div.onmouseover = () => { div.style.background = '#444'; div.style.color = 'white'; };
            div.onmouseout = () => { div.style.background = 'transparent'; div.style.color = '#ccc'; };
            div.onclick = () => Signal.connectTo(c);
            list.appendChild(div);
        });
    },
    
    connectTo: function(id) {
        if(!Signal.peer) return BIO.toast("Login first.");
        Signal.conn = Signal.peer.connect(id);
        Signal.setupConn();
        Signal.log("<i>Connecting to " + id + "...</i>");
    },
    
    setupConn: function() {
        Signal.conn.on('open', () => {
            Signal.log("<b style='color:#0f0'>Connected.</b>");
        });
        Signal.conn.on('data', (data) => {
            Signal.log("<b style='color:cyan'>" + Signal.conn.peer + ":</b> " + data);
            BIO.toast("New Message from " + Signal.conn.peer);
        });
        Signal.conn.on('close', () => Signal.log("<i>Disconnected.</i>"));
    },
    
    send: function() {
        const inp = document.getElementById('sig-msg');
        const msg = inp.value;
        if(!msg || !Signal.conn) return;
        Signal.conn.send(msg);
        Signal.log("<b>Me:</b> " + msg);
        inp.value = '';
    },
    
    log: function(html) {
        const div = document.getElementById('sig-log');
        div.innerHTML += '<div>'+html+'</div>';
        div.scrollTop = div.scrollHeight;
    }
};

Kernel.createWindow('SIGNAL', 550, 400, html, 'win-signal');
setTimeout(Signal.init, 100);
`
                    },
                    // --- CORRECTED PRISM (NO ALERTS, NO PROMPTS) ---
                    "prism.js": { 
                        type: 'file', 
                        content: `
/* --- PRISM SILENT MODE --- */
const html = '<div style="display:flex; flex-direction:column; height:100%; background:#222; color:white; font-family:monospace;">' +
    '<div style="display:flex; background:#444; padding:5px; gap:5px;">' +
        '<button onclick="Prism.setMode(\\\'lock\\\')" id="p-btn-lock" style="flex:1;">LOCK (Hide)</button>' +
        '<button onclick="Prism.setMode(\\\'unlock\\\')" id="p-btn-unlock" style="flex:1;">UNLOCK (Reveal)</button>' +
    '</div>' +
    '<div id="prism-view" style="flex:1; padding:10px; display:flex; flex-direction:column; gap:10px;"></div>' +
    '</div>';

window.Prism = {
    mode: 'lock',
    img: null,
    
    setMode: function(m) {
        Prism.mode = m;
        Prism.render();
    },
    
    render: function() {
        const v = document.getElementById('prism-view');
        const bLock = document.getElementById('p-btn-lock');
        const bUnlock = document.getElementById('p-btn-unlock');
        
        bLock.style.background = Prism.mode==='lock' ? '#AA0000' : '#555';
        bUnlock.style.background = Prism.mode==='unlock' ? '#00AA00' : '#555';

        if(Prism.mode === 'lock') {
            v.innerHTML = '<div style="background:black; padding:5px; border:1px solid #555;">1. DRAG IMAGE INTO WINDOW</div>' +
            '<input id="p-path" placeholder="Path will appear here" readonly style="background:#333; color:white; padding:5px; border:1px solid #555;">' + 
            '<textarea id="p-msg" placeholder="Type Secret Message Here..." style="flex:1; background:black; color:#0f0; border:1px solid #555; padding:5px;"></textarea>' +
            '<button onclick="Prism.encode()" style="padding:10px; background:purple; color:white; font-weight:bold; border:2px solid white;">ENCODE & SAVE TO DISK</button>';
        } else {
            v.innerHTML = '<div style="background:black; padding:5px; border:1px solid #555;">1. DRAG SECRET IMAGE INTO WINDOW</div>' +
            '<input id="p-path" placeholder="Path will appear here" readonly style="background:#333; color:white; padding:5px; border:1px solid #555;">' +
            '<div id="p-out" style="flex:1; background:black; border:1px solid #555; color:#0f0; padding:10px; white-space:pre-wrap; overflow:auto;">[Message will appear here]</div>' +
            '<button onclick="Prism.decode()" style="padding:10px; background:green; color:white; font-weight:bold; border:2px solid white;">DECODE MESSAGE</button>';
        }
    },
    
    loadImgFromDrop: function(path, content) {
        document.getElementById('p-path').value = path;
        const img = new Image();
        img.onload = () => { 
            Prism.img = img; 
            BIO.toast("Image Loaded into Prism"); 
        };
        img.src = content;
    },
    
    encode: function() {
        if(!Prism.img) return BIO.toast("Drag an image in first!");
        const msg = document.getElementById('p-msg').value;
        if(!msg) return BIO.toast("Enter a message to hide.");
        
        const c = document.createElement('canvas');
        c.width = Prism.img.width; c.height = Prism.img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(Prism.img, 0, 0);
        const imgData = ctx.getImageData(0, 0, c.width, c.height);
        const data = imgData.data;
        
        let bin = "";
        for (let i = 0; i < msg.length; i++) {
            bin += msg.charCodeAt(i).toString(2).padStart(8, '0');
        }
        bin += "00000000"; 
        
        if (bin.length > data.length / 4) return BIO.toast("Message too long for this image!");
        
        for (let i = 0; i < bin.length; i++) {
            const pixelIndex = i * 4; 
            const bit = parseInt(bin[i]);
            data[pixelIndex + 2] = (data[pixelIndex + 2] & 254) | bit;
        }
        
        ctx.putImageData(imgData, 0, 0);
        
        const newUrl = c.toDataURL('image/png'); 
        const oldPath = document.getElementById('p-path').value;
        const newPath = oldPath.replace('.png', '_secret.png').replace('.jpg', '_secret.png');
        
        // SILENT SAVE, NO PROMPT
        BIO.saveFile(newPath, newUrl);
        BIO.toast("Secret Image Saved: " + newPath);
    },
    
    decode: function() {
        if(!Prism.img) return BIO.toast("Drag an image in first!");
        const c = document.createElement('canvas');
        c.width = Prism.img.width; c.height = Prism.img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(Prism.img, 0, 0);
        const data = ctx.getImageData(0, 0, c.width, c.height).data;
        
        let bin = "";
        let char = "";
        let msg = "";
        
        for (let i = 0; i < data.length; i += 4) {
            const bit = data[i + 2] & 1; 
            char += bit;
            if (char.length === 8) {
                const code = parseInt(char, 2);
                if (code === 0) break; 
                msg += String.fromCharCode(code);
                char = "";
            }
        }
        document.getElementById('p-out').innerText = msg;
        BIO.toast("Decoding Complete.");
    }
};

Kernel.createWindow('PRISM v2.1', 400, 500, html, 'win-prism');
Prism.render();

const win = document.getElementById('win-prism');
if(win) {
    win.ondragover = (e) => e.preventDefault();
    win.ondrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const files = e.dataTransfer.files;
        if(files.length > 0) {
            const f = files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                Prism.loadImgFromDrop(f.name, evt.target.result);
            };
            reader.readAsDataURL(f);
        }
    };
}
` 
                    },
                    "nexus.js": { type: 'file', content: `const id='win-nexus';const html='<div style="display:flex; flex-direction:column; height:100%; background:#ccc;"><div style="padding:5px; display:flex; gap:5px; border-bottom:1px solid black;"><input id="nx-url" value="/www/bookmarks.html" style="flex:1;" placeholder="http://... or /www/file.html"><button onclick="Nexus.go()">GO</button></div><div style="flex:1; background:white; position:relative;"><iframe id="nx-frame" style="width:100%; height:100%; border:none;"></iframe></div></div>';window.Nexus={go:function(){let url=document.getElementById('nx-url').value;const frame=document.getElementById('nx-frame');if(url.includes('localhost')||url.startsWith('/www/')){let path=url.replace('http://localhost','').replace('localhost','');if(path===''||path==='/')path='/index.html';if(!path.startsWith('/'))path='/'+path;const file=BIO.resolve(path);if(file){frame.srcdoc=file.content}else{frame.srcdoc="<h1>404 NOT FOUND</h1><p>File does not exist in /www/</p>"}}else{if(!url.startsWith('http'))url='https://'+url;frame.removeAttribute('srcdoc');frame.src=url}}};Kernel.createWindow('NEXUS WEB',650,500,html,id);Nexus.go();` },
                    "taskmgr.js": { type: 'file', content: `const html = '<div style="height:100%; display:flex; flex-direction:column; padding:10px;"><div style="border-bottom:1px solid black; font-weight:bold;">ACTIVE PROCESSES</div><div id="proc-list" style="flex:1; overflow:auto; margin-top:5px;"></div><button onclick="TaskMgr.refresh()" style="margin-top:5px;">REFRESH</button></div>';window.TaskMgr = {refresh: function() {const list = document.getElementById('proc-list');list.innerHTML = '';const wins = window.Kernel.activeWindows;for(let id in wins) {const row = document.createElement('div');row.style.borderBottom = '1px dotted #ccc';row.style.display = 'flex'; row.style.justifyContent = 'space-between';row.innerHTML = '<span>'+wins[id]+'</span> <button onclick="Kernel.closeWindow(\\''+id+'\\');TaskMgr.refresh()" style="background:red;color:white;border:none;cursor:pointer;">KILL</button>';list.appendChild(row)}}};Kernel.createWindow('TASK_MANAGER', 300, 400, html, 'win-taskmgr');TaskMgr.refresh();` },
                    "config_editor.js": { type: 'file', content: `const html = '<div style="height:100%; display:flex; flex-direction:column; padding:10px;"><h3>SYSTEM CONFIGURATION</h3><p>Changes apply immediately upon save.</p><textarea id="cfg-data" style="flex:1; margin-bottom:10px; font-family:monospace;"></textarea><button onclick="Config.save()" style="padding:10px;">SAVE & APPLY</button></div>';window.Config = {init: function() {const file = BIO.resolve('/system/config.json');if(file) document.getElementById('cfg-data').value = file.content.trim();},save: function() {const data = document.getElementById('cfg-data').value;try { JSON.parse(data); } catch(e) { return BIO.toast("INVALID JSON"); }BIO.saveFile('/system/config.json', data);BIO.applyTheme();}};Kernel.createWindow('SETTINGS', 400, 500, html, 'win-cfg');Config.init();` },
                    "manifest.js": { type: 'file', content: `window.Manifest={render:function(path){const dir=BIO.resolve(path);let html='<div style="background:#ddd; padding:5px; border-bottom:1px solid black;">PATH: '+path+'</div><div class="file-list">';if(path!=='/'){const parent=path.substring(0,path.lastIndexOf('/'))||'/';html+='<div class="file-row"><span class="f-icon" onclick="Manifest.render(\\''+parent+'\\')">üîô</span><span class="f-name" onclick="Manifest.render(\\''+parent+'\\')">.. (UP)</span></div>'}if(dir){for(let key in dir){const fullPath=(path==='/'?'':path)+'/'+key;const item=dir[key];const isDir=item.type==='dir';const icon=isDir?'üìÅ':(key.endsWith('.snd')?'üéµ':'üìÑ');const clickAction=isDir?"Manifest.render(\\''+fullPath+'\\')":"BIO.runScript(\\''+fullPath+'\\')";html+='<div class="file-row"><span class="f-icon" onclick="'+clickAction+'">'+icon+'</span><span class="f-name" onclick="'+clickAction+'">'+key+'</span>';if(!isDir){html+='<button class="f-btn" onclick="BIO.editFile(\\''+fullPath+'\\')">EDIT</button><button class="f-btn" onclick="BIO.runScript(\\''+fullPath+'\\')">RUN</button><button class="f-btn exp" onclick="BIO.exportFile(\\''+fullPath+'\\')">EXP</button>'}else{html+='<button class="f-btn" onclick="Manifest.render(\\''+fullPath+'\\')">OPEN</button>'}html+='<button class="f-btn del" onclick="BIO.deleteFile(\\''+fullPath+'\\'); Manifest.render(\\''+path+'\\')">DEL</button></div>'}}html+='</div>';const existing=document.getElementById('win-manifest');if(existing){existing.querySelector('.content').innerHTML=html;existing.style.zIndex=++BIO.zIndex}else{Kernel.createWindow('MANIFEST',450,400,html,'win-manifest')}}};Manifest.render('/home');` },
                    "notepad.js": { type: 'file', content: `window.Notepad=function(path,content){const id='note-'+Math.random().toString(36).substr(2,5);const safeContent=content?content.replace(/</g,'&lt;'):'';const initialPath=path||'/home/untitled.txt';const html='<div style="display:flex; flex-direction:column; height:100%;"><div style="background:#eee; padding:5px; border-bottom:1px solid black; display:flex; flex-direction:column; gap:5px;"><div style="display:flex; gap:5px;"><span style="line-height:24px;">FILE:</span><input id="path-'+id+'" value="'+initialPath+'" style="flex:1; font-family:monospace;"></div><div style="display:flex; gap:5px;"><button onclick="Notepad.save(\\''+id+'\\')">üíæ SAVE TO DISK</button><button onclick="BIO.runCode(document.getElementById(\\'txt-'+id+'\\').value)">‚ñ∂ TEST CODE</button></div></div><textarea id="txt-'+id+'" oninput="this.style.height=\\'\\';this.style.height=this.scrollHeight+\\'px\\'" style="flex-grow:1; border:none; resize:none; padding:10px; font-family:Courier New; font-size:14px; white-space:pre; background:white; color:black; overflow:hidden; min-height:300px;">'+safeContent+'</textarea></div>';Kernel.createWindow('SCRIBE',500,450,html,id)};window.Notepad.save=function(id){const path=document.getElementById('path-'+id).value;const content=document.getElementById('txt-'+id).value;BIO.saveFile(path,content)};if(typeof _ARGS!=='undefined'&&_ARGS)Notepad(_ARGS.path,_ARGS.content);else Notepad(null,'');` },
                    "terminal.js": { type: 'file', content: `const id='win-term';const html='<div style="background:black; color:white; padding:5px; height:100%; overflow:auto;" onclick="document.getElementById(\\'cmd\\').focus()"><div id="term-log">DIVINE OS SHELL (Core_29)<br>Type "help" for commands.<br></div><div style="display:flex"><span>> </span><input id="cmd" style="flex:1; background:transparent; border:none; color:yellow; outline:none;" onkeydown="TERM(event,this)"></div></div>';window.TERM=function(e,inp){if(e.key==='Enter'){const val=inp.value.trim();document.getElementById('term-log').innerHTML+='<div>> '+val+'</div>';const parts=val.split(' ');const c=parts[0];const arg=parts[1];if(c==='ls')BIO.runScript('/core/manifest.js');else if(c==='help')document.getElementById('term-log').innerHTML+='<div>CMD: ls, run, edit, mkdir, rm, cat, export, heal, clear</div><div style="color:cyan">UNLOCK: injector, bluescan, subspace, identity</div>';else if(c==='injector'){if(!BIO.resolve('/system/injector.flag')){BIO.saveFile('/system/injector.flag','TRUE');BIO.toast('SYSTEM HACK: INJECTOR UNLOCKED');}BIO.runScript('/core/injector.js');}else if(c==='bluescan'){if(!BIO.resolve('/system/bluescan.flag')){BIO.saveFile('/system/bluescan.flag','TRUE');BIO.toast('BLUESCAN MODULE UNLOCKED');}BIO.runScript('/core/bluescan.js');}else if(c==='subspace'){if(!BIO.resolve('/system/subspace.flag')){BIO.saveFile('/system/subspace.flag','TRUE');BIO.toast('SUBSPACE MODULE UNLOCKED');}BIO.runScript('/core/subspace.js');}else if(c==='identity'){if(!BIO.resolve('/system/identity.flag')){BIO.saveFile('/system/identity.flag','TRUE');BIO.toast('IDENTITY MODULE UNLOCKED');}BIO.runScript('/core/identity.js');}else if(c==='run'&&arg)BIO.runScript(arg);else if(c==='edit'&&arg)BIO.editFile(arg);else if(c==='mkdir'&&arg){BIO.saveFile(arg,'',true);document.getElementById('term-log').innerHTML+='<div>Created Dir: '+arg+'</div>'}else if(c==='rm'&&arg){BIO.deleteFile(arg);document.getElementById('term-log').innerHTML+='<div>Deleted: '+arg+'</div>'}else if(c==='cat'&&arg){const f=BIO.resolve(arg);if(f)document.getElementById('term-log').innerHTML+='<div style="white-space:pre;color:#ccc;">'+f.content.substring(0,200)+'</div>';else document.getElementById('term-log').innerHTML+='<div>File not found.</div>'}else if(c==='export'&&arg)BIO.exportFile(arg);else if(c==='heal')BIO.heal();else if(c==='clear')document.getElementById('term-log').innerHTML='';else document.getElementById('term-log').innerHTML+='<div>Unknown command.</div>';inp.value='';inp.scrollIntoView()}};Kernel.createWindow('TERMINAL',500,300,html,id);` },
                    "snake.js": { type: 'file', content: `const html='<div style="display:flex;justify-content:center;align-items:center;height:100%;background:#444;"><canvas id="gc" width="300" height="300" style="background:#555;border:2px solid white;"></canvas></div>';Kernel.createWindow('SERPENT',340,360,html,'win-snake');setTimeout(()=>{const c=document.getElementById('gc');if(!c)return;const ctx=c.getContext('2d');let px=10,py=10,gs=20,tc=15,ax=12,ay=12,xv=1,yv=0,trail=[],tail=5;setInterval(()=>{if(!document.getElementById('gc'))return;px+=xv;py+=yv;if(px<0)px=tc-1;if(px>tc-1)px=0;if(py<0)py=tc-1;if(py>tc-1)py=0;ctx.fillStyle='#0000AA';ctx.fillRect(0,0,300,300);ctx.fillStyle='lime';for(let i=0;i<trail.length;i++){ctx.fillRect(trail[i].x*gs,trail[i].y*gs,gs-2,gs-2);if(trail[i].x==px&&trail[i].y==py)tail=5}trail.push({x:px,y:py});while(trail.length>tail)trail.shift();if(ax==px&&ay==py){tail++;ax=Math.floor(Math.random()*tc);ay=Math.floor(Math.random()*tc)}ctx.fillStyle='red';ctx.fillRect(ax*gs,ay*gs,gs-2,gs-2)},100);document.onkeydown=e=>{if(e.key==='ArrowLeft'){xv=-1;yv=0}if(e.key==='ArrowUp'){xv=0;yv=-1}if(e.key==='ArrowRight'){xv=1;yv=0}if(e.key==='ArrowDown'){xv=0;yv=1}}},100);` },
                    "paint.js": { type: 'file', content: `const html='<div style="height:100%;display:flex;flex-direction:column;"><div style="background:#ccc;padding:5px;flex-shrink:0;"><button onclick="window.PC=\\\'black\\\'">BLK</button><button onclick="window.PC=\\\'red\\\'">RED</button><button onclick="window.PC=\\\'blue\\\'">BLU</button></div><div style="flex-grow:1;overflow:auto;background:#888;display:flex;justify-content:center;align-items:center;"><canvas id="pc" width="400" height="300" style="background:white;cursor:crosshair;border:1px solid black;"></canvas></div></div>';Kernel.createWindow('CANVAS',450,400,html,'win-paint');setTimeout(()=>{const c=document.getElementById('pc');const x=c.getContext('2d');let d=false;window.PC='black';c.onmousedown=e=>{d=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY)};c.onmouseup=()=>{d=false};c.onmousemove=e=>{if(!d)return;x.strokeStyle=window.PC;x.lineWidth=4;x.lineTo(e.offsetX,e.offsetY);x.stroke()}},100);` },
                    "calc.js": { type: 'file', content: `const html='<div style="padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:5px;height:100%;align-content:start;"><input id="c-d" style="grid-column:span 4;text-align:right;font-size:18px;margin-bottom:5px;"><button onclick="cA(7)">7</button><button onclick="cA(8)">8</button><button onclick="cA(9)">9</button><button onclick="cA(\\\'/\\\')">/</button><button onclick="cA(4)">4</button><button onclick="cA(5)">5</button><button onclick="cA(6)">6</button><button onclick="cA(\\\'*\\\')">*</button><button onclick="cA(1)">1</button><button onclick="cA(2)">2</button><button onclick="cA(3)">3</button><button onclick="cA(\\\'-\\\')">-</button><button onclick="cA(\\\'C\\\')">C</button><button onclick="cA(0)">0</button><button onclick="cE()">=</button><button onclick="cA(\\\'+(\\\')">+</button></div>';window.cA=v=>{let d=document.getElementById('c-d');if(v=='C')d.value='';else d.value+=v;};window.cE=()=>{let d=document.getElementById('c-d');try{d.value=eval(d.value)}catch{d.value='ERR'}};Kernel.createWindow('ABACUS',250,300,html,'win-calc');` },
                    "mines.js": { type: 'file', content: `let size=9,bombs=10,grid=[],gover=false;const html='<div style="background:#c0c0c0;padding:10px;text-align:center;height:100%;overflow:auto;"><div id="mine-msg" style="margin-bottom:5px;border:2px inset white;background:black;color:red;font-size:20px;">000</div><div id="mine-grid" style="display:grid;grid-template-columns:repeat(9,30px);gap:2px;background:#888;padding:2px;width:fit-content;margin:auto;"></div><button onclick="Mines.init()" style="margin-top:5px;">RESET</button></div>';window.Mines={init:function(){grid=[];gover=false;document.getElementById('mine-msg').innerText='PLAY';const g=document.getElementById('mine-grid');g.innerHTML='';for(let i=0;i<size*size;i++){grid[i]={b:false,r:false,f:false};const btn=document.createElement('div');btn.style.width='30px';btn.style.height='30px';btn.style.background='#ccc';btn.style.border='2px outset white';btn.style.cursor='pointer';btn.style.lineHeight='26px';btn.style.fontWeight='bold';btn.onclick=()=>Mines.click(i);btn.oncontextmenu=(e)=>{e.preventDefault();Mines.flag(i)};btn.id='m-'+i;g.appendChild(btn)}let bCount=0;while(bCount<bombs){let r=Math.floor(Math.random()*grid.length);if(!grid[r].b){grid[r].b=true;bCount++}}},click:function(i){if(gover||grid[i].f||grid[i].r)return;grid[i].r=true;const el=document.getElementById('m-'+i);el.style.border='1px dotted #888';el.style.background='#eee';if(grid[i].b){el.style.background='red';el.innerText='üí£';gover=true;document.getElementById('mine-msg').innerText='FAIL'}else{let c=Mines.count(i);if(c>0){el.innerText=c;el.style.color=['blue','green','red','purple'][c-1]||'black'}else{let q=[i];while(q.length){let curr=q.pop();let adj=Mines.getAdj(curr);adj.forEach(n=>{if(!grid[n].r&&!grid[n].b&&!grid[n].f){grid[n].r=true;let cel=document.getElementById('m-'+n);cel.style.border='1px dotted #888';cel.style.background='#eee';let cc=Mines.count(n);if(cc>0){cel.innerText=cc;cel.style.color=['blue','green','red','purple'][cc-1]||'black'}else q.push(n)}})}}}},flag:function(i){if(gover||grid[i].r)return;grid[i].f=!grid[i].f;document.getElementById('m-'+i).innerText=grid[i].f?'üö©':''},getAdj:function(i){let x=i%size,y=Math.floor(i/size),a=[];for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){if(dx==0&&dy==0)continue;let nx=x+dx,ny=y+dy;if(nx>=0&&nx<size&&ny>=0&&ny<size)a.push(ny*size+nx)}return a},count:function(i){return Mines.getAdj(i).filter(n=>grid[n].b).length}};Kernel.createWindow('MINES',330,420,html,'win-mines');Mines.init();` },
                    "synth.js": { type: 'file', content: `const ctx=new(window.AudioContext||window.webkitAudioContext);
                    let rec=null, chunks=[];
                    const html='<div style="background:#222;min-height:300px;display:flex;flex-direction:column;padding:10px;">' +
                    '<div style="display:flex; justify-content:space-between; margin-bottom:5px;">' +
                        '<div style="color:white;font-weight:bold;">SYNTH v2</div>' +
                        '<button id="rec-btn" onclick="Synth.toggleRec()" style="background:red;color:white;border:2px solid white;cursor:pointer;">‚óè REC</button>' +
                    '</div>' +
                    '<div style="flex:1;background:black;border:2px inset white;margin-bottom:10px;position:relative;"><canvas id="vis" width="280" height="100" style="width:100%;height:100%;"></canvas></div>' +
                    '<div style="display:flex;justify-content:center;gap:5px;flex-shrink:0;">'+['C4','D4','E4','F4','G4','A4','B4','C5'].map((n,i)=>'<button onmousedown="Synth.play('+(261.63*Math.pow(1.059463,[0,2,4,5,7,9,11,12][i]))+')" style="height:100px;width:40px;background:white;border-radius:0 0 5px 5px;cursor:pointer;">'+n+'</button>').join('')+'</div></div>';
                    
                    window.Synth={
                        dest: ctx.createMediaStreamDestination(),
                        toggleRec: function() {
                            const btn = document.getElementById('rec-btn');
                            if(rec && rec.state === 'recording') {
                                rec.stop();
                                btn.innerText = "‚óè REC";
                                btn.style.background = "red";
                            } else {
                                chunks = [];
                                let name = prompt("Filename:", "track.snd"); // Prompt here is tricky, let's use a default if null for silent mode or just keep prompt as it's user initiated logic
                                if(!name) name = "track.snd";
                                rec = new MediaRecorder(Synth.dest.stream);
                                rec.ondataavailable = e => chunks.push(e.data);
                                rec.onstop = e => {
                                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                                    const reader = new FileReader();
                                    reader.onload = function(evt) {
                                        BIO.saveFile('/home/' + (name.endsWith('.snd')?name:name+'.snd'), evt.target.result);
                                    };
                                    reader.readAsDataURL(blob);
                                };
                                rec.start();
                                btn.innerText = "‚ñ† STOP";
                                btn.style.background = "white";
                                btn.style.color = "red";
                            }
                        },
                        play:function(f){
                            if(ctx.state==='suspended')ctx.resume();
                            const o=ctx.createOscillator(),g=ctx.createGain();
                            o.type='sawtooth';
                            o.frequency.setValueAtTime(f,ctx.currentTime);
                            g.gain.setValueAtTime(0.2,ctx.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
                            o.connect(g);
                            g.connect(ctx.destination);
                            g.connect(Synth.dest); // Output to Recorder
                            o.start();
                            o.stop(ctx.currentTime+0.5);
                            const c=document.getElementById('vis');
                            if(c){
                                const cx=c.getContext('2d');
                                cx.fillStyle='rgba(0,0,0,0.2)';
                                cx.fillRect(0,0,c.width,c.height);
                                cx.fillStyle='#0f0';
                                cx.fillRect(Math.random()*c.width,Math.random()*c.height,20,20)
                            }
                        }
                    };
                    Kernel.createWindow('SYNTH',400,300,html,'win-synth');` 
                    },
                    "chronos.js": { type: 'file', content: `let startTime=0,elapsed=0,timerInt=null;const html='<div style="background:#333;color:#0f0;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:monospace;height:100%;"><div id="time-disp" style="font-size:40px;border:4px double #0f0;padding:10px;margin-bottom:20px;background:black;flex-shrink:0;">00:00.00</div><div style="flex-shrink:0;"><button onclick="Chronos.start()" style="padding:10px;font-weight:bold;color:green;">START</button> <button onclick="Chronos.stop()" style="padding:10px;font-weight:bold;color:red;">STOP</button> <button onclick="Chronos.reset()" style="padding:10px;font-weight:bold;">RESET</button></div><div id="laps" style="margin-top:10px;font-size:12px;flex-grow:1;width:80%;border-top:1px solid #555;overflow-y:auto;"></div></div>';window.Chronos={update:function(){const n=Date.now(),d=n-startTime+elapsed,ms=Math.floor((d%1000)/10),s=Math.floor((d/1000)%60),m=Math.floor((d/60000));document.getElementById('time-disp').innerText=(m<10?'0'+m:m)+':'+(s<10?'0'+s:s)+'.'+(ms<10?'0'+ms:ms)},start:function(){if(timerInt)return;startTime=Date.now();timerInt=setInterval(Chronos.update,10)},stop:function(){if(!timerInt)return;elapsed+=Date.now()-startTime;clearInterval(timerInt);timerInt=null;const d=document.createElement('div');d.innerText="LAP: "+document.getElementById('time-disp').innerText;document.getElementById('laps').prepend(d)},reset:function(){Chronos.stop();elapsed=0;document.getElementById('time-disp').innerText="00:00.00";document.getElementById('laps').innerHTML=""}};Kernel.createWindow('CHRONOS',300,300,html,'win-chronos');` }
                }
            }
        }
    },
    
    resolve: function(path) {
        if(path === '/') return BIO.fs.root;
        const parts = path.split('/').filter(p => p);
        let curr = BIO.fs.root;
        for(let p of parts) {
            if(curr.type==='dir' && curr.content[p]) curr = curr.content[p];
            else if(curr[p]) curr = curr[p];
            else return null;
        }
        if(curr.type === 'dir') return curr.content;
        return curr;
    },
    
    // --- BIOS LOGGING ---
    log: function(msg) {
        const el = document.createElement('div');
        el.className = 'log-line';
        el.innerText = "> " + msg;
        document.getElementById('boot-log').appendChild(el);
    },
    
    sysLog: function(msg) {
        const logFile = BIO.resolve('/var/sys.log');
        if(logFile) {
            const time = new Date().toLocaleTimeString();
            logFile.content += `[${time}] ${msg}\n`;
            BIO.saveFile('/var/sys.log', logFile.content, false, true);
        }
    },

    // --- IMMERSIVE NOTIFICATIONS (NO ALERTS) ---
    toast: function(msg) {
        const c = document.getElementById('toast-container');
        if(!c) return;
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerText = '> ' + msg;
        c.appendChild(t);
        // Fade out and remove
        setTimeout(() => {
            t.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => t.remove(), 500);
        }, 3000);
    },
    
    crash: function(msg) {
        document.getElementById('bsod').style.display = 'flex';
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('bios-screen').style.display = 'none';
    },
    
    heal: function() {
        BIO.sysLog("SYSTEM: Manual Heal Initiated...");
        function merge(def, curr) {
            for(let key in def) {
                if(!curr[key]) { curr[key] = JSON.parse(JSON.stringify(def[key])); } 
                else if(def[key].type === 'dir' && curr[key].type === 'dir') { merge(def[key].content, curr[key].content); }
            }
        }
        merge(BIO.defaultFS.root, BIO.fs.root);
        // Save encrypted
        const str = JSON.stringify(BIO.fs);
        const encrypted = CryptoJS.AES.encrypt(str, BIO.masterKey).toString();
        localStorage.setItem('divineOS_disk', encrypted);
        BIO.log("SYSTEM: Core files restored.");
        setTimeout(() => BIO.reboot(), 1000);
    },
    
    // --- NEW: SYSTEM UNLOCKER ---
    unlockSystem: function() {
        const pass = document.getElementById('boot-pass').value;
        if(!pass) return alert("KEY REQUIRED");
        BIO.masterKey = pass;
        
        // Hide UI and proceed with reboot logic
        document.getElementById('auth-ui').style.display = 'none';
        BIO.reboot(true); // Pass true to signal we are unlocked
    },

    // --- MAIN REBOOT SEQUENCE ---
    reboot: function(isUnlocked) {
        // --- 1. SECURITY CHECK ---
        const saved = localStorage.getItem('divineOS_disk');
        
        // If system has data but no key, show "UNLOCK" screen
        if(saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            
            document.getElementById('auth-msg').innerText = "SYSTEM LOCKED // DECRYPT";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }

        // If system is new (no data), show "SETUP" screen
        if(!saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            
            document.getElementById('auth-msg').innerText = "NEW SYSTEM // CREATE KEY";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }

        // Proceed to boot if unlocked
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('bsod').style.display = 'none';
        document.getElementById('bios-screen').style.display = 'flex';
        document.getElementById('boot-log').innerHTML = '';
        document.getElementById('toast-container').innerHTML = ''; // Clear toasts
        
        delete window.Kernel;
        
        let step = 0;
        const steps = [
            () => BIO.log("BIOS: Checking Memory... OK"),
            () => {
                BIO.log("BIOS: Decrypting File System...");
                if(saved) {
                    try {
                        // --- 2. DECRYPTION LOGIC ---
                        const bytes = CryptoJS.AES.decrypt(saved, BIO.masterKey);
                        const str = bytes.toString(CryptoJS.enc.Utf8);
                        
                        // CRITICAL FIX: IF DECRYPT FAILS, THROW ERROR. DO NOT LOAD DEFAULT.
                        if(!str) throw "WRONG_KEY";
                        
                        BIO.fs = JSON.parse(str);
                        BIO.log("FS: Decrypted & Mounted.");
                    } catch(e) {
                        // IF WRONG PASSWORD, THIS CRASHES HERE
                        BIO.masterKey = null;
                        alert("ACCESS DENIED: WRONG PASSWORD");
                        location.reload();
                        return;
                    }
                } else {
                    BIO.fs = JSON.parse(JSON.stringify(BIO.defaultFS));
                    BIO.log("FS: New Drive Initialized (Encrypted).");
                }
            },
            () => {
                const k = BIO.resolve('/system/kernel.js');
                if(!k) throw "KERNEL_MISSING";
                new Function(k.content)();
            },
            () => { BIO.applyTheme(); },
            () => {
                const b = BIO.resolve('/system/boot.js');
                if(!b) throw "BOOT_MISSING";
                new Function(b.content)();
            },
            () => {
                document.getElementById('bios-screen').style.display = 'none';
                document.getElementById('desktop').style.display = 'block';
                document.getElementById('taskbar').style.display = 'flex';
            }
        ];
        
        const tick = setInterval(() => {
            try {
                if(step < steps.length) { steps[step](); step++; }
                else clearInterval(tick);
            } catch(e) {
                clearInterval(tick);
                BIO.crash(e);
            }
        }, 300);
    },
    
    saveFile: function(path, content, isDir, silent) {
        if(!path) return;
        const parts = path.split('/').filter(p => p);
        const fileName = parts.pop();
        let curr = BIO.fs.root;
        
        for(let p of parts) {
            if(!curr[p]) curr[p] = { type: 'dir', content: {} };
            if(curr[p].type === 'dir') curr = curr[p].content;
            else return;
        }
        
        if(isDir) curr[fileName] = { type: 'dir', content: {} };
        else curr[fileName] = { type: 'file', content: content };
        
        // --- 3. ENCRYPTION ON SAVE ---
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            const encrypted = CryptoJS.AES.encrypt(str, BIO.masterKey).toString();
            localStorage.setItem('divineOS_disk', encrypted);
        }
        
        if(path === '/system/config.json') BIO.applyTheme();
        
        if(!silent && !isDir) BIO.toast("Saved: " + fileName);
        if(document.getElementById('win-manifest')) Manifest.render(path.substring(0, path.lastIndexOf('/')) || '/');
    },
    
    exportFile: function(path) {
        const file = BIO.resolve(path);
        if(!file || file.type !== 'file') return BIO.toast("FILE NOT FOUND");

        const parts = path.split('/');
        const fileName = parts[parts.length - 1];
        let url;

        if(file.content.startsWith('data:')) {
            url = file.content;
        } else {
            const blob = new Blob([file.content], { type: 'text/plain' });
            url = URL.createObjectURL(blob);
        }

        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        if(!file.content.startsWith('data:')) URL.revokeObjectURL(url);
        
        BIO.toast("Exported to System Downloads"); 
    },
    
    deleteFile: function(path) {
        const parts = path.split('/').filter(p=>p);
        const name = parts.pop();
        let curr = BIO.fs.root;
        for(let p of parts) { if(curr.type==='dir' && curr.content[p]) curr = curr.content[p]; else return; }
        if(curr.content) delete curr.content[name]; else delete curr[name];
        
        // --- 4. ENCRYPTION ON DELETE ---
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            const encrypted = CryptoJS.AES.encrypt(str, BIO.masterKey).toString();
            localStorage.setItem('divineOS_disk', encrypted);
        }
        BIO.toast("Deleted: " + name); 
    },
    
    factoryReset: function() {
        if(confirm("WARNING: WIPE EVERYTHING?")) {
            localStorage.removeItem('divineOS_disk');
            localStorage.removeItem('divineOS_signal_user');
            localStorage.removeItem('divineOS_signal_contacts');
            location.reload();
        }
    },
    
    applyTheme: function() {
        const file = BIO.resolve('/system/config.json');
        if(!file) { document.documentElement.style.setProperty('--bg', '#000000'); return; }
        try { const cfg = JSON.parse(file.content); const r = document.documentElement; for(let key in cfg.theme) r.style.setProperty(key, cfg.theme[key]); } catch(e) {}
    },
    
    runScript: function(path) {
        const file = BIO.resolve(path);
        if(!file || file.type !== 'file') return BIO.toast("FILE NOT FOUND: " + path);
        try {
            if(file.content.startsWith('data:image')) {
                const title = path.split('/').pop().toUpperCase();
                const html = '<div style="display:flex;justify-content:center;align-items:center;min-height:100%;background:black;"><img src="'+file.content+'" style="max-width:none;image-rendering:pixelated;"></div>';
                Kernel.createWindow(title, 400, 400, html);
                return;
            }
            if(path.endsWith('.snd') || file.content.startsWith('data:audio')) {
                const title = path.split('/').pop().toUpperCase();
                const id = 'player-' + Math.random().toString(36).substr(2, 5);
                
                // Custom Divine Player UI
                const html = `
                <div style="display:flex; flex-direction:column; height:100%; background:black; padding:10px; font-family:monospace; color:#0f0;">
                    <div style="flex:1; border:2px solid #333; margin-bottom:5px; display:flex; align-items:center; justify-content:center; background:#111;">
                        <div id="viz-${id}" style="font-size:20px; letter-spacing:5px;">AUDIO_OUT_ACTIVE</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <button id="btn-${id}" style="background:#00AA00; color:white; border:2px outset white; font-weight:bold; width:50px; cursor:pointer;">‚ñ∂</button>
                        <div style="flex:1; height:10px; background:#333; border:1px solid #555; position:relative;">
                            <div id="bar-${id}" style="width:0%; height:100%; background:#0f0;"></div>
                        </div>
                        <div id="time-${id}" style="font-size:12px;">00:00</div>
                    </div>
                    <audio id="aud-${id}" src="${file.content}" style="display:none;"></audio>
                </div>
                `;

                Kernel.createWindow(title, 350, 150, html);

                // Inject Player Logic
                setTimeout(() => {
                    const aud = document.getElementById('aud-' + id);
                    const btn = document.getElementById('btn-' + id);
                    const bar = document.getElementById('bar-' + id);
                    const time = document.getElementById('time-' + id);
                    const viz = document.getElementById('viz-' + id);

                    if(!aud) return;

                    btn.onclick = function() {
                        if(aud.paused) { aud.play(); btn.innerText = 'II'; viz.innerText = 'PLAYING >>'; }
                        else { aud.pause(); btn.innerText = '‚ñ∂'; viz.innerText = 'PAUSED'; }
                    };

                    aud.ontimeupdate = function() {
                        const pct = (aud.currentTime / aud.duration) * 100;
                        bar.style.width = pct + '%';
                        const m = Math.floor(aud.currentTime / 60);
                        const s = Math.floor(aud.currentTime % 60);
                        time.innerText = (m<10?'0'+m:m) + ':' + (s<10?'0'+s:s);
                    };

                    aud.onended = function() {
                         btn.innerText = '‚ñ∂';
                         bar.style.width = '0%';
                         viz.innerText = 'FINISHED';
                    };
                }, 100);
                return;
            }
            window._ARGS = null; const f = new Function(file.content); f();
        } catch(e) { BIO.toast("EXEC ERROR: " + e.message); }
    },
    
    editFile: function(path) {
        const file = BIO.resolve(path);
        if(!file) return BIO.toast("FILE NOT FOUND");
        const noteFile = BIO.resolve('/core/notepad.js');
        if(noteFile) { window._ARGS = { path: path, content: file.content }; new Function(noteFile.content)(); }
    },
    
    handleDrop: function(e) {
        e.preventDefault();
        document.getElementById('desktop').classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
            const items = e.dataTransfer.items;
            for(let i=0; i<items.length; i++) {
                if(items[i].kind === 'file') {
                    const file = items[i].getAsFile();
                    let name = file.name;
                    
                    if(file.type.startsWith('audio/')) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            name = name.replace(/\.[^/.]+$/, "") + ".snd";
                            BIO.saveFile('/home/'+name, evt.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                    else if(file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            // RAW SAVE FOR PRISM
                            BIO.saveFile('/home/'+name, evt.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        const reader = new FileReader();
                        reader.onload = function(evt) { BIO.saveFile('/home/'+name, evt.target.result); };
                        reader.readAsText(file);
                    }
                }
            }
            return;
        }

        const imageUrl = e.dataTransfer.getData('URL');
        if (imageUrl) {
            BIO.saveFile('/home/link_' + Date.now() + '.html', '<html><body><img src="'+imageUrl+'"></body></html>');
        }
    }
};

window.onload = function() {
    // 4. INSTALL APP
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    const d = document.body;
    d.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('desktop').classList.add('drag-over'); });
    d.addEventListener('dragleave', e => { e.preventDefault(); document.getElementById('desktop').classList.remove('drag-over'); });
    d.addEventListener('drop', BIO.handleDrop);
    
    // START BOOT PROCESS (Will stop for Password)
    BIO.reboot();
    
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
}
</script>
</body>
</html>
