<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DivineOS // Injector_Mode_v9.6_CHECKPOINT</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<style>
    /* --- SYSTEM AESTHETICS (DARK/HACKER MODE) --- */
    :root {
        --bg: #0000AA;
        --win: #FFFFFF;
        --text: #000000;
        --accent: #AA0000;
        --highlight: #00AAAA;
        --dim: #AAAAAA;
    }
    * { box-sizing: border-box; user-select: none; }
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        overflow: hidden; font-family: 'Courier New', monospace;
        background-color: #000; color: var(--text); cursor: crosshair; font-weight: bold;
        transition: background 0.3s;
    }

    /* BIOS SCREEN */
    #bios-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; padding: 20px; z-index: 999999;
        display: flex; flex-direction: column; justify-content: flex-start;
        font-size: 14px; line-height: 1.5; overflow: hidden;
    }
    .log-line { display: block; animation: fadein 0.1s; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

    /* BSOD */
    #bsod {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000088; color: white; padding: 50px; z-index: 1000000;
        font-family: 'Courier New', monospace;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }

    /* DESKTOP */
    #desktop {
        width: 100%; height: calc(100% - 40px); position: relative;
        background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        background-color: var(--bg);
        display: none; overflow: hidden;
    }
    #desktop.drag-over { background-color: rgba(255,255,255,0.2); }

    /* NOTIFICATIONS (Top Right) */
    #toast-container {
        position: absolute; top: 10px; right: 10px;
        width: 300px; display: flex; flex-direction: column; gap: 5px;
        z-index: 999999; pointer-events: none;
    }
    .toast {
        background: rgba(0,0,0,0.9); color: #0f0; 
        border: 1px solid #0f0; padding: 10px; 
        font-size: 12px; font-family: 'Courier New';
        box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
        animation: slideIn 0.3s forwards;
        pointer-events: auto;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* ICONS */
    .desktop-icon {
        position: absolute; width: 90px; height: 90px;
        text-align: center; color: white; cursor: pointer;
        padding: 5px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; z-index: 10;
        border: 1px dotted transparent;
        text-shadow: 1px 1px 0 #000;
    }
    .icon-img { 
        font-size: 32px; margin-bottom: 5px; width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
        border: 4px double rgba(255,255,255,0.5); border-radius: 4px;
        box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        transition: transform 0.1s, filter 0.1s;
    }
    .desktop-icon:hover .icon-img { transform: translateY(-2px); filter: brightness(1.2); border-color: white; }
    .icon-label { font-size: 12px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 2px; }
    .desktop-icon:hover .icon-label { background: black; }

    /* WINDOWS */
    .window {
        position: absolute; background: var(--win); color: var(--text);
        border: 4px double var(--accent);
        box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
        display: flex; flex-direction: column;
        min-width: 200px; min-height: 150px;
    }
    .title-bar {
        background: var(--accent); color: #FFFF55;
        padding: 5px; display: flex; justify-content: space-between;
        align-items: center; cursor: grab; border-bottom: 2px solid black;
        font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
        flex-shrink: 0;
    }
    .close-btn {
        background: var(--highlight); color: white; border: 1px solid black;
        width: 20px; height: 20px; text-align: center; line-height: 16px;
        cursor: pointer;
    }
    .close-btn:hover { background: white; color: black; }
    .content { flex-grow: 1; overflow: auto; position: relative; }
    .resize-handle {
        width: 15px; height: 15px; background: var(--accent);
        position: absolute; bottom: 0; right: 0; cursor: nwse-resize;
        z-index: 10; clip-path: polygon(100% 0, 100% 100%, 0 100%);
    }

    /* TASKBAR */
    #taskbar {
        position: absolute; bottom: 0; left: 0;
        width: 100%; height: 40px; background: var(--dim);
        border-top: 4px solid white; display: none; align-items: center;
        padding: 0 10px; z-index: 9999;
    }
    #start-btn {
        background: var(--highlight); color: white; border: 3px outset white;
        padding: 5px 15px; font-weight: bold; margin-right: 15px; cursor: pointer;
    }
    #reboot-btn {
        background: red; color: white; border: 3px outset white;
        padding: 5px 10px; font-weight: bold; margin-right: 15px; cursor: pointer;
        font-size: 10px;
    }
    .task-tab {
        background: white; border: 2px solid black; padding: 5px 10px;
        margin-right: 5px; cursor: pointer; font-size: 12px;
        box-shadow: 3px 3px 0px #555;
        color: black;
    }

    /* APP UI */
    .file-list { padding: 10px; }
    .file-row { display: flex; align-items: center; padding: 5px; border-bottom: 1px dotted #ccc; }
    .file-row:hover { background: #eee; }
    .f-icon { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; cursor: pointer; }
    .f-name { flex-grow: 1; font-size: 14px; cursor: pointer; }
    .f-btn { 
        border: 1px solid black; background: #ddd; 
        font-size: 10px; padding: 2px 5px; margin-left: 5px; 
        cursor: pointer; font-family: 'Courier New'; font-weight: bold;
    }
    .f-btn:hover { background: black; color: white; }
    .f-btn.del { color: red; }
    .f-btn.exp { color: white; background: blue; border-color: darkblue; }
    .f-btn.exp:hover { background: cyan; color: black; }
    textarea { font-family: 'Courier New'; font-weight: bold; }
</style>
</head>
<body>

<div id="bios-screen">
    <div>DIVINE BIOS v9.6 (SECURE_BOOT)</div>
    <div id="bios-status-line">System Status...</div>
    <br>
    <div id="boot-log"></div>
    
    <div id="auth-ui" style="display:none; margin-top:20px; border:1px solid white; padding:20px;">
        <p id="auth-msg">SECURE BOOT</p>
        <input type="password" id="boot-pass" placeholder="ENTER KEY" onkeydown="if(event.key==='Enter')BIO.unlockSystem()" style="background:black; color:white; border:none; border-bottom:2px solid white; font-family:monospace; font-size:18px; text-align:center; width:100%;">
        <br><br>
        <button onclick="BIO.unlockSystem()" style="background:white; color:black; font-weight:bold; padding:5px 20px; cursor:pointer;">PROCEED</button>
    </div>

    <div style="margin-top:auto; color:red; border-top:1px solid red; padding-top:5px;">
        [F8] EMERGENCY: <button onclick="BIO.factoryReset()">FACTORY RESET (WIPE DISK)</button>
    </div>
</div>

<div id="bsod">
    <h1 style="background: white; color: blue; padding: 5px;">FATAL SYSTEM ERROR</h1>
    <button onclick="BIO.factoryReset()" style="padding:10px; font-weight:bold; color:red;">FACTORY RESET</button>
</div>

<div id="desktop">
    <div id="toast-container"></div>
</div>

<div id="taskbar">
    <button id="start-btn" onclick="BIO.runScript('/core/manifest.js')">SYSTEM</button>
    <button id="reboot-btn" onclick="BIO.reboot()">‚ü≥ REBOOT</button>
    <div id="task-list" style="display: flex;"></div>
    <div style="margin-left: auto; color: blue;" id="clock">00:00</div>
</div>

<script>
/* ----------------------------------------------------
   THE BIOS (Basic Input/Output System)
   ----------------------------------------------------
*/
const BIO = {
    zIndex: 100,
    fs: null, 
    masterKey: null, 
    
    // DEFAULT FS (CLEAN STATE)
    defaultFS: {
        root: {
            home: { 
                type: 'dir', 
                content: {
                    public: { type: 'dir', content: {} } // PUBLIC FOLDER FOR MESH
                } 
            },
            var: { type: 'dir', content: { 
                "sys.log": { type: 'file', content: "--- SYSTEM LOG STARTED ---\n" } 
            }},
            www: {
                type: 'dir',
                content: {
                    "index.html": { type: 'file', content: `<h1>WELCOME TO DIVINE NET</h1><p>Local Secure Intranet.</p><hr><ul><li><a href="bookmarks.html">>> OPEN BOOKMARKS <<</a></li><li><a href="about.html">System Info</a></li><li><a href="contact.html">Contact Root</a></li></ul>` },
                    "bookmarks.html": { type: 'file', content: `<style>body{font-family:monospace;padding:10px;} .warn{background:#ffcccc;border:2px solid red;padding:10px;margin-bottom:20px;color:red;font-weight:bold;} .safe{background:#ccffcc;border:2px solid green;padding:10px;margin-bottom:10px;color:green;font-weight:bold;}</style><h1>NEXUS GATEWAY</h1><div class="warn">‚ö† NOTICE: Standard sites (YouTube, Google) block iframes. Use the ASTRAL MIRRORS below.</div><h3>ASTRAL MIRRORS (UNBLOCKED)</h3><ul><li><a href="https://yewtu.be">YouTube (Yewtu.be Mirror)</a></li><li><a href="https://google.com/webhp?igu=1">Google (Unblocked Mode)</a></li><li><a href="https://nitter.net">Twitter (Nitter Mirror)</a></li><li><a href="https://libreddit.frehed.org">Reddit (LibReddit Mirror)</a></li><li><a href="https://duckduckgo.com">DuckDuckGo (Privacy Search)</a></li><li><a href="https://web.archive.org">Wayback Machine</a></li></ul><hr><a href="index.html">Back to Local Index</a>` },
                    "about.html": { type: 'file', content: `<h1>ABOUT</h1><p>DivineOS is a Javascript based environment running in local RAM.</p><a href="index.html">Back</a>` },
                    "contact.html": { type: 'file', content: `<h1>CONTACT</h1><p>Admin: ROOT_USER</p><a href="index.html">Back</a>` }
                }
            },
            system: {
                type: 'dir',
                content: {
                    "config.json": { type: 'file', content: `{\n    "theme": {\n        "--bg": "#0000AA",\n        "--win": "#FFFFFF",\n        "--text": "#000000",\n        "--accent": "#AA0000",\n        "--highlight": "#00AAAA",\n        "--dim": "#AAAAAA"\n    },\n    "system": { "clockFormat": "local", "username": "TESTER" }\n}` },
                    "kernel.js": { type: 'file', content: `
window.Kernel = {
    activeWindows: {},
    createWindow: function(title, w, h, html, id) {
        if (!BIO.resolve('/system/kernel.js')) { BIO.crash("KERNEL_NOT_FOUND_ON_DISK"); return; }
        BIO.applyTheme(); 
        if(id && document.getElementById(id)) return;
        const winId = id || 'win-'+Math.random().toString(36).substr(2,5);
        const win = document.createElement('div');
        win.className = 'window'; win.id = winId;
        win.style.width = w+'px'; win.style.height = h+'px';
        win.style.left = (150 + (BIO.zIndex%10)*30)+'px';
        win.style.top = (50 + (BIO.zIndex%10)*30)+'px';
        win.style.zIndex = ++BIO.zIndex;
        
        const bar = document.createElement('div');
        bar.className = 'title-bar';
        bar.innerHTML = '<span>'+title+'</span> <div class="close-btn" onclick="Kernel.closeWindow(\\''+winId+'\\')">X</div>';
        
        const cont = document.createElement('div');
        cont.className = 'content'; cont.innerHTML = html;
        const resize = document.createElement('div');
        resize.className = 'resize-handle';
        
        win.appendChild(bar); win.appendChild(cont); win.appendChild(resize);
        document.getElementById('desktop').appendChild(win);
        Kernel.makeDraggable(win, bar); Kernel.makeResizable(win, resize);
        
        const tab = document.createElement('div');
        tab.className = 'task-tab'; tab.id = 'tab-'+winId; tab.innerText = title;
        tab.onclick = function(){ win.style.display='flex'; win.style.zIndex=++BIO.zIndex; };
        document.getElementById('task-list').appendChild(tab);
        Kernel.activeWindows[winId] = title;
    },
    closeWindow: function(id) {
        const w = document.getElementById(id); if(w) w.remove();
        const t = document.getElementById('tab-'+id); if(t) t.remove();
        delete Kernel.activeWindows[id];
    },
    makeDraggable: function(elm, handle) {
        let pos1=0, pos2=0, pos3=0, pos4=0;
        handle.onmousedown = function(e) {
            if(e.target.className === 'close-btn') return;
            e.preventDefault(); pos3=e.clientX; pos4=e.clientY;
            document.onmouseup = function() { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = function(e) {
                e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY;
                elm.style.top = (elm.offsetTop - pos2) + "px"; elm.style.left = (elm.offsetLeft - pos1) + "px";
            };
        };
        elm.onmousedown = function() { elm.style.zIndex = ++BIO.zIndex; }
    },
    makeResizable: function(elm, handle) {
        handle.onmousedown = function(e) {
            e.preventDefault(); e.stopPropagation();
            const startX = e.clientX; const startY = e.clientY;
            const startW = parseInt(document.defaultView.getComputedStyle(elm).width, 10);
            const startH = parseInt(document.defaultView.getComputedStyle(elm).height, 10);
            document.onmouseup = function() { document.onmouseup=null; document.onmousemove=null; };
            document.onmousemove = function(e) {
                elm.style.width = (startW + e.clientX - startX) + 'px'; elm.style.height = (startH + e.clientY - startY) + 'px';
            };
        };
    }
};` 
                    },
                    "boot.js": { type: 'file', content: `
BIO.applyTheme();
BIO.sysLog("BOOT: System Loaded.");

// --- RESTORED ALL ICONS ---
const icons = [
    {name: 'TERMINAL', icon: 'üíª', run: '/core/terminal.js', x:0, y:0, color:'#000000'},
    {name: 'MANIFEST', icon: 'üìÇ', run: '/core/manifest.js', x:0, y:1, color:'#AA8800'}, 
    {name: 'SETTINGS', icon: '‚öôÔ∏è', run: '/core/config_editor.js', x:0, y:2, color:'#555555'},
    {name: 'TASKMGR',  icon: 'üìä', run: '/core/taskmgr.js',  x:0, y:3, color:'#005500'},

    {name: 'SCRIBE',   icon: 'üìù', run: '/core/notepad.js', x:1, y:0, color:'#0000AA'}, 
    {name: 'PRISM',    icon: 'üíé', run: '/core/prism.js',   x:1, y:1, color:'#8800FF'}, 
    {name: 'CANVAS',   icon: 'üé®', run: '/core/paint.js',   x:1, y:2, color:'#AA00AA'}, 
    {name: 'ABACUS',   icon: 'üßÆ', run: '/core/calc.js',    x:1, y:3, color:'#555555'},

    {name: 'SYNTH',    icon: 'üéπ', run: '/core/synth.js',   x:2, y:0, color:'#333333'},
    {name: 'SERPENT',  icon: 'üêç', run: '/core/snake.js',   x:2, y:1, color:'#00AA00'}, 
    {name: 'MINES',    icon: 'üí£', run: '/core/mines.js',   x:2, y:2, color:'#AA0000'}, 
    {name: 'CHRONOS',  icon: '‚è±Ô∏è', run: '/core/chronos.js', x:2, y:3, color:'#00AAAA'}, 

    {name: 'NEXUS',    icon: 'üåç', run: '/core/nexus.js',    x:3, y:0, color:'#0000FF'},
    {name: 'SIGNAL',   icon: 'üì°', run: '/core/signal.js',   x:3, y:1, color:'#FF4400'},
    {name: 'MESH',     icon: 'üï∏Ô∏è', run: '/core/mesh.js',     x:3, y:2, color:'#3333FF'},

    /* --- UNLOCKABLE TEMPLE TOOLS --- */
    {name: 'SPIRIT',   icon: 'üì°', run: '/core/bluescan.js', x:4, y:0, color:'#0000AA', flag:'bluescan.flag'},
    {name: 'ORACLE',   icon: 'üõ∞Ô∏è', run: '/core/subspace.js', x:4, y:1, color:'#005500', flag:'subspace.flag'},
    {name: 'WITNESS',  icon: 'üëÅÔ∏è', run: '/core/identity.js', x:4, y:2, color:'#AA0000', flag:'identity.flag'},
    {name: 'INJECTOR', icon: 'üíâ', run: '/core/injector.js', x:4, y:3, color:'#CC0000', flag:'injector.flag'},
    {name: 'BURNING',  icon: 'üî•', run: '/core/heatwave.js', x:5, y:0, color:'#FF3300', flag:'heatwave.flag'}
];

icons.forEach(i => {
    if(i.flag && !BIO.resolve('/system/'+i.flag)) return; 
    
    const d = document.createElement('div');
    d.className = 'desktop-icon';
    d.style.left = (20 + i.x*100) + 'px';
    d.style.top = (20 + i.y*100) + 'px';
    d.innerHTML = '<span class="icon-img" style="background-color:'+i.color+'">'+i.icon+'</span><span class="icon-label">'+i.name+'</span>';
    d.onmousedown = function(e) {
        if(!window.Kernel) return; 
        BIO.runScript(i.run); 
    };
    document.getElementById('desktop').appendChild(d);
});
BIO.runScript('/core/terminal.js');` 
                    }
                }
            },
            core: {
                type: 'dir',
                content: {
                    // --- TEMPLE STYLE APPS ---
                    "heatwave.js": { type: 'file', content: `const html = '<div style="background:#FFFFFF;color:#000000;padding:10px;height:100%;font-family:monospace;display:flex;flex-direction:column;border:4px double #AA0000;"><div style="text-align:center;font-size:24px;border-bottom:4px double #AA0000;margin-bottom:10px;color:#AA0000;font-weight:bold;">BURNING BUSH</div><div style="flex:1;text-align:center;display:flex;flex-direction:column;justify-content:center;"><div id="hw-status" style="font-size:18px;margin-bottom:20px;background:#AA0000;color:white;padding:5px;">STATUS: COLD</div><div id="hw-count" style="margin-bottom:10px;font-weight:bold;">THREADS: 0</div></div><button id="hw-btn" onclick="Heatwave.toggle()" style="padding:20px;font-size:20px;font-weight:bold;background:#AA0000;color:white;border:4px outset #ff0000;cursor:pointer;">IGNITE FIRE</button></div>';window.Heatwave={workers:[],toggle:function(){const btn=document.getElementById('hw-btn');const stat=document.getElementById('hw-status');const count=document.getElementById('hw-count');if(Heatwave.workers.length>0){Heatwave.workers.forEach(w=>w.terminate());Heatwave.workers=[];btn.innerText="IGNITE FIRE";btn.style.background="#AA0000";btn.style.color="white";stat.innerText="STATUS: EXTINGUISHED";stat.style.background="#0000AA";count.innerText="THREADS: 0"}else{const cores=navigator.hardwareConcurrency||4;const threads=cores*2;const blob=new Blob([\`self.onmessage=function(){while(true){Math.random()}}\`],{type:'application/javascript'});const url=URL.createObjectURL(blob);for(let i=0;i<threads;i++){const w=new Worker(url);w.postMessage('burn');Heatwave.workers.push(w)}btn.innerText="CEASE FIRE";btn.style.background="#000000";btn.style.color="red";stat.innerText="‚ö† WARNING: BURNING ‚ö†";stat.style.background="red";count.innerText="THREADS: "+threads}}};Kernel.createWindow('BURNING BUSH',350,400,html,'win-heat');` },
                    "bluescan.js": { type: 'file', content: `const html = '<div style="background:#0000AA;color:#FFFFFF;padding:10px;height:100%;display:flex;flex-direction:column;font-family:monospace;border:4px double white;"><div style="border-bottom:2px solid white;padding:5px;text-align:center;font-size:20px;font-weight:bold;">SPIRIT RECEIVER</div><button onclick="BlueScan.scan()" style="margin:10px 0;background:white;color:blue;font-weight:bold;padding:10px;cursor:pointer;border:4px outset #cccccc;">SCAN ETHER</button><div id="bs-log" style="flex:1;overflow:auto;border:2px solid white;padding:5px;background:white;color:black;">Waiting for spirit...</div></div>';window.BlueScan={scan:function(){const log=document.getElementById('bs-log');log.innerHTML+='<div>Scanning...</div>';if(!navigator.bluetooth){log.innerHTML+='<div style="color:red">HARDWARE MISSING</div>';return}navigator.bluetooth.requestDevice({acceptAllDevices:true}).then(device=>{log.innerHTML+='<div style="background:#ccc;margin-top:5px;font-weight:bold;">FOUND: '+(device.name||'Unknown Device')+'</div>';log.innerHTML+='<div style="font-size:10px;">ID: '+device.id+'</div>'}).catch(error=>{log.innerHTML+='<div style="color:red;">SILENCE.</div>'})}};Kernel.createWindow('SPIRIT WAVE',350,400,html,'win-blue');` },
                    "subspace.js": { type: 'file', content: `const html = '<div style="background:#00AAAA;color:black;padding:10px;height:100%;font-family:monospace;display:flex;flex-direction:column;border:4px double black;"><div style="border-bottom:2px solid black;margin-bottom:10px;text-align:center;font-size:20px;font-weight:bold;">ORACLE MAPPER</div><div id="ss-grid" style="flex:1;overflow:auto;border:2px solid black;padding:5px;background:white;"></div><button onclick="Subspace.pingAll()" style="margin-top:10px;background:white;color:black;border:4px outset black;padding:8px;cursor:pointer;font-weight:bold;">CAST NET</button></div>';window.Subspace={targets:['192.168.0.1','192.168.1.1','192.168.1.254','10.0.0.1','10.0.0.138','172.16.0.1','127.0.0.1'],pingAll:function(){const grid=document.getElementById('ss-grid');grid.innerHTML='<div>Mapping...</div>';Subspace.targets.forEach(ip=>{const row=document.createElement('div');row.style.borderBottom='1px dotted black';row.innerText='PING > '+ip;grid.appendChild(row);const start=Date.now();fetch('http://'+ip,{mode:'no-cors',signal:AbortSignal.timeout(1500)}).then(()=>{row.innerHTML='<span style="color:green;font-weight:bold;">[ALIVE]</span> '+ip}).catch(e=>{if(e.name==='AbortError')row.innerHTML='<span style="color:grey;">[DEAD]</span> '+ip;else row.innerHTML='<span style="color:green;font-weight:bold;">[ALIVE]</span> '+ip})})}};Kernel.createWindow('ORACLE NET',400,450,html,'win-sub');` },
                    "identity.js": { type: 'file', content: `const html = '<div style="background:#FFFFFF;color:#0000AA;padding:10px;height:100%;font-family:monospace;border:4px double #0000AA;"><div style="text-align:center;font-size:20px;border-bottom:4px double #0000AA;margin-bottom:10px;font-weight:bold;">SOUL WITNESS</div><div id="id-data" style="margin-top:10px;padding:10px;border:2px solid #0000AA;">Loading...</div></div>';window.Identity={init:function(){const d=document.getElementById('id-data');let txt='';txt+='<div>AGENT: '+navigator.userAgent.substring(0,30)+'...</div><hr style="border-top:1px solid #0000AA;">';txt+='<div>CORES: '+(navigator.hardwareConcurrency||'?')+'</div>';txt+='<div>RAM: '+(navigator.deviceMemory||'?')+' GB</div>';txt+='<div>PLATFORM: '+navigator.platform+'</div>';txt+='<div>LANGUAGE: '+navigator.language+'</div>';txt+='<div>ONLINE: '+navigator.onLine+'</div>';if(navigator.getBattery){navigator.getBattery().then(b=>{const batt='<div>POWER: '+(b.level*100)+'% '+(b.charging?'[CHARGING]':'[DRAINING]')+'</div>';d.innerHTML+=batt})}d.innerHTML=txt}};Kernel.createWindow('SOUL WITNESS',400,500,html,'win-id');Identity.init();` },
                    // --- CORE APPS RESTORED ---
                    "injector.js": { type: 'file', content: "const html='<div style=\"padding:10px;background:#111;color:#0f0;height:100%\"><b>INJECTOR MODE</b><br><br><input type=\"color\" oninput=\"document.documentElement.style.setProperty(\\'--bg\\',this.value)\"><br>Background Color<br><br><input type=\"color\" oninput=\"document.documentElement.style.setProperty(\\'--accent\\',this.value)\"><br>Accent Color<br><br><button onclick=\"BIO.saveFile(\\'/system/injector.flag\\',\\'TRUE\\');BIO.toast(\\'PERMANENT ROOT ACCESS GRANTED\\')\">UNLOCK PERMANENT ROOT</button></div>';Kernel.createWindow('INJECTOR',300,400,html,'win-inj');" },
                    "mesh.js": { type: 'file', content: "const html='<div style=\"background:#222;color:white;padding:10px;height:100%\"><b>MESH NETWORK</b><br>ID: <span id=\"m-id\">...</span><br><br><input id=\"m-target\" placeholder=\"Target ID\"><button onclick=\"Mesh.conn()\">CONNECT</button><div id=\"m-log\"></div></div>';window.Mesh={init:function(){let u=localStorage.getItem('divineOS_signal_user')||'anon'+Math.floor(Math.random()*999);const p=new Peer(u+'_net');p.on('open',i=>document.getElementById('m-id').innerText=i);p.on('connection',c=>{Mesh.c=c;c.on('data',d=>BIO.toast('MESH DATA: '+d))})},conn:function(){const t=document.getElementById('m-target').value;const c=new Peer().connect(t);c.on('open',()=>c.send('HELLO FROM MESH'))}};Kernel.createWindow('MESH',300,300,html,'win-mesh');setTimeout(Mesh.init,1000);" },
                    "nexus.js": { type: 'file', content: "const id='win-nexus';const html='<div style=\"display:flex;flex-direction:column;height:100%;background:#ccc\"><div style=\"padding:5px;display:flex;gap:5px\"><input id=\"nx-url\" value=\"/www/bookmarks.html\" style=\"flex:1\" onkeydown=\"if(event.key===\\'Enter\\')Nexus.go()\"><button onclick=\"Nexus.go()\">GO</button></div><iframe id=\"nx-frame\" style=\"flex:1;border:none\"></iframe></div>';window.Nexus={go:function(){let u=document.getElementById('nx-url').value;if(u.includes('youtube.com'))u='https://yewtu.be';if(u.includes('reddit.com'))u='https://libreddit.frehed.org';const f=document.getElementById('nx-frame');if(u.startsWith('/www')){const file=BIO.resolve(u);f.srcdoc=file?file.content:'404'}else{f.src=u.startsWith('http')?u:'https://'+u}}};Kernel.createWindow('NEXUS',600,500,html,id);Nexus.go();" },
                    "taskmgr.js": { type: 'file', content: `const html = '<div style="height:100%; display:flex; flex-direction:column; padding:10px;"><div style="border-bottom:1px solid black; font-weight:bold;">ACTIVE PROCESSES</div><div id="proc-list" style="flex:1; overflow:auto; margin-top:5px;"></div><button onclick="TaskMgr.refresh()" style="margin-top:5px;">REFRESH</button></div>';window.TaskMgr = {refresh: function() {const list = document.getElementById('proc-list');list.innerHTML = '';const wins = window.Kernel.activeWindows;for(let id in wins) {const row = document.createElement('div');row.style.borderBottom = '1px dotted #ccc';row.style.display = 'flex'; row.style.justifyContent = 'space-between';row.innerHTML = '<span>'+wins[id]+'</span> <button onclick="Kernel.closeWindow(\\''+id+'\\');TaskMgr.refresh()" style="background:red;color:white;border:none;cursor:pointer;">KILL</button>';list.appendChild(row)}}};Kernel.createWindow('TASK_MANAGER', 300, 400, html, 'win-taskmgr');TaskMgr.refresh();` },
                    "config_editor.js": { type: 'file', content: `const html = '<div style="height:100%; display:flex; flex-direction:column; padding:10px;"><h3>SYSTEM CONFIGURATION</h3><p>Changes apply immediately upon save.</p><textarea id="cfg-data" style="flex:1; margin-bottom:10px; font-family:monospace;"></textarea><button onclick="Config.save()" style="padding:10px;">SAVE & APPLY</button></div>';window.Config = {init: function() {const file = BIO.resolve('/system/config.json');if(file) document.getElementById('cfg-data').value = file.content.trim();},save: function() {const data = document.getElementById('cfg-data').value;try { JSON.parse(data); } catch(e) { return BIO.toast("INVALID JSON"); }BIO.saveFile('/system/config.json', data);BIO.applyTheme();}};Kernel.createWindow('SETTINGS', 400, 500, html, 'win-cfg');Config.init();` },
                    "manifest.js": { type: 'file', content: `window.Manifest={render:function(path){const dir=BIO.resolve(path);let html='<div style="background:#ddd; padding:5px; border-bottom:1px solid black;">PATH: '+path+'</div><div class="file-list">';if(path!=='/'){const parent=path.substring(0,path.lastIndexOf('/'))||'/';html+='<div class="file-row"><span class="f-icon" onclick="Manifest.render(\\''+parent+'\\')">üîô</span><span class="f-name" onclick="Manifest.render(\\''+parent+'\\')">.. (UP)</span></div>'}if(dir){for(let key in dir){const fullPath=(path==='/'?'':path)+'/'+key;const item=dir[key];const isDir=item.type==='dir';const icon=isDir?'üìÅ':(key.endsWith('.snd')?'üéµ':'üìÑ');const clickAction=isDir?"Manifest.render(\\''+fullPath+'\\')":"BIO.runScript(\\''+fullPath+'\\')";html+='<div class="file-row"><span class="f-icon" onclick="'+clickAction+'">'+icon+'</span><span class="f-name" onclick="'+clickAction+'">'+key+'</span>';if(!isDir){html+='<button class="f-btn" onclick="BIO.editFile(\\''+fullPath+'\\')">EDIT</button><button class="f-btn" onclick="BIO.runScript(\\''+fullPath+'\\')">RUN</button><button class="f-btn exp" onclick="BIO.exportFile(\\''+fullPath+'\\')">EXP</button>'}else{html+='<button class="f-btn" onclick="Manifest.render(\\''+fullPath+'\\')">OPEN</button>'}html+='<button class="f-btn del" onclick="BIO.deleteFile(\\''+fullPath+'\\'); Manifest.render(\\''+path+'\\')">DEL</button></div>'}}html+='</div>';const existing=document.getElementById('win-manifest');if(existing){existing.querySelector('.content').innerHTML=html;existing.style.zIndex=++BIO.zIndex}else{Kernel.createWindow('MANIFEST',450,400,html,'win-manifest')}}};Manifest.render('/home');` },
                    "notepad.js": { type: 'file', content: `window.Notepad=function(path,content){const id='note-'+Math.random().toString(36).substr(2,5);const safeContent=content?content.replace(/</g,'&lt;'):'';const initialPath=path||'/home/untitled.txt';const html='<div style="display:flex; flex-direction:column; height:100%;"><div style="background:#eee; padding:5px; border-bottom:1px solid black; display:flex; flex-direction:column; gap:5px;"><div style="display:flex; gap:5px;"><span style="line-height:24px;">FILE:</span><input id="path-'+id+'" value="'+initialPath+'" style="flex:1; font-family:monospace;"></div><div style="display:flex; gap:5px;"><button onclick="Notepad.save(\\''+id+'\\')">üíæ SAVE TO DISK</button><button onclick="BIO.runCode(document.getElementById(\\'txt-'+id+'\\').value)">‚ñ∂ TEST CODE</button></div></div><textarea id="txt-'+id+'" oninput="this.style.height=\\'\\';this.style.height=this.scrollHeight+\\'px\\'" style="flex-grow:1; border:none; resize:none; padding:10px; font-family:Courier New; font-size:14px; white-space:pre; background:white; color:black; overflow:hidden; min-height:300px;">'+safeContent+'</textarea></div>';Kernel.createWindow('SCRIBE',500,450,html,id)};window.Notepad.save=function(id){const path=document.getElementById('path-'+id).value;const content=document.getElementById('txt-'+id).value;BIO.saveFile(path,content)};if(typeof _ARGS!=='undefined'&&_ARGS)Notepad(_ARGS.path,_ARGS.content);else Notepad(null,'');` },
                    "terminal.js": { type: 'file', content: `const id='win-term';const html='<div style="background:black; color:white; padding:5px; height:100%; overflow:auto;" onclick="document.getElementById(\\'cmd\\').focus()"><div id="term-log">DIVINE OS SHELL (Core_30)<br>Type "help" for commands.<br></div><div style="display:flex"><span>> </span><input id="cmd" style="flex:1; background:transparent; border:none; color:yellow; outline:none;" onkeydown="TERM(event,this)"></div></div>';window.TERM=function(e,inp){if(e.key==='Enter'){const val=inp.value.trim();document.getElementById('term-log').innerHTML+='<div>> '+val+'</div>';const parts=val.split(' ');const c=parts[0];const arg=parts[1];if(c==='ls')BIO.runScript('/core/manifest.js');else if(c==='help')document.getElementById('term-log').innerHTML+='<div>CMD: ls, run, edit, mkdir, rm, cat, export, heal, clear</div><div style="color:cyan">UNLOCK: injector, bluescan, subspace, identity, heatwave</div>';else if(c==='injector'){if(!BIO.resolve('/system/injector.flag')){BIO.saveFile('/system/injector.flag','TRUE');BIO.toast('SYSTEM HACK: INJECTOR UNLOCKED');}BIO.runScript('/core/injector.js');}else if(c==='bluescan'){if(!BIO.resolve('/system/bluescan.flag')){BIO.saveFile('/system/bluescan.flag','TRUE');BIO.toast('SPIRIT UNLOCKED');}BIO.runScript('/core/bluescan.js');}else if(c==='subspace'){if(!BIO.resolve('/system/subspace.flag')){BIO.saveFile('/system/subspace.flag','TRUE');BIO.toast('ORACLE UNLOCKED');}BIO.runScript('/core/subspace.js');}else if(c==='identity'){if(!BIO.resolve('/system/identity.flag')){BIO.saveFile('/system/identity.flag','TRUE');BIO.toast('WITNESS UNLOCKED');}BIO.runScript('/core/identity.js');}else if(c==='heatwave'){if(!BIO.resolve('/system/heatwave.flag')){BIO.saveFile('/system/heatwave.flag','TRUE');BIO.toast('HEATWAVE PROTOCOL UNLOCKED');}BIO.runScript('/core/heatwave.js');}else if(c==='run'&&arg)BIO.runScript(arg);else if(c==='edit'&&arg)BIO.editFile(arg);else if(c==='mkdir'&&arg){BIO.saveFile(arg,'',true);document.getElementById('term-log').innerHTML+='<div>Created Dir: '+arg+'</div>'}else if(c==='rm'&&arg){BIO.deleteFile(arg);document.getElementById('term-log').innerHTML+='<div>Deleted: '+arg+'</div>'}else if(c==='cat'&&arg){const f=BIO.resolve(arg);if(f)document.getElementById('term-log').innerHTML+='<div style="white-space:pre;color:#ccc;">'+f.content.substring(0,200)+'</div>';else document.getElementById('term-log').innerHTML+='<div>File not found.</div>'}else if(c==='export'&&arg)BIO.exportFile(arg);else if(c==='heal')BIO.heal();else if(c==='clear')document.getElementById('term-log').innerHTML='';else document.getElementById('term-log').innerHTML+='<div>Unknown command.</div>';inp.value='';inp.scrollIntoView()}};Kernel.createWindow('TERMINAL',500,300,html,id);` },
                    "snake.js": { type: 'file', content: `const html='<div style="display:flex;justify-content:center;align-items:center;height:100%;background:#444;"><canvas id="gc" width="300" height="300" style="background:#555;border:2px solid white;"></canvas></div>';Kernel.createWindow('SERPENT',340,360,html,'win-snake');setTimeout(()=>{const c=document.getElementById('gc');if(!c)return;const ctx=c.getContext('2d');let px=10,py=10,gs=20,tc=15,ax=12,ay=12,xv=1,yv=0,trail=[],tail=5;setInterval(()=>{if(!document.getElementById('gc'))return;px+=xv;py+=yv;if(px<0)px=tc-1;if(px>tc-1)px=0;if(py<0)py=tc-1;if(py>tc-1)py=0;ctx.fillStyle='#0000AA';ctx.fillRect(0,0,300,300);ctx.fillStyle='lime';for(let i=0;i<trail.length;i++){ctx.fillRect(trail[i].x*gs,trail[i].y*gs,gs-2,gs-2);if(trail[i].x==px&&trail[i].y==py)tail=5}trail.push({x:px,y:py});while(trail.length>tail)trail.shift();if(ax==px&&ay==py){tail++;ax=Math.floor(Math.random()*tc);ay=Math.floor(Math.random()*tc)}ctx.fillStyle='red';ctx.fillRect(ax*gs,ay*gs,gs-2,gs-2)},100);document.onkeydown=e=>{if(e.key==='ArrowLeft'){xv=-1;yv=0}if(e.key==='ArrowUp'){xv=0;yv=-1}if(e.key==='ArrowRight'){xv=1;yv=0}if(e.key==='ArrowDown'){xv=0;yv=1}}},100);` },
                    "paint.js": { type: 'file', content: `const html='<div style="height:100%;display:flex;flex-direction:column;"><div style="background:#ccc;padding:5px;flex-shrink:0;"><button onclick="window.PC=\\\'black\\\'">BLK</button><button onclick="window.PC=\\\'red\\\'">RED</button><button onclick="window.PC=\\\'blue\\\'">BLU</button></div><div style="flex-grow:1;overflow:auto;background:#888;display:flex;justify-content:center;align-items:center;"><canvas id="pc" width="400" height="300" style="background:white;cursor:crosshair;border:1px solid black;"></canvas></div></div>';Kernel.createWindow('CANVAS',450,400,html,'win-paint');setTimeout(()=>{const c=document.getElementById('pc');const x=c.getContext('2d');let d=false;window.PC='black';c.onmousedown=e=>{d=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY)};c.onmouseup=()=>{d=false};c.onmousemove=e=>{if(!d)return;x.strokeStyle=window.PC;x.lineWidth=4;x.lineTo(e.offsetX,e.offsetY);x.stroke()}},100);` },
                    "calc.js": { type: 'file', content: `const html='<div style="padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:5px;height:100%;align-content:start;"><input id="c-d" style="grid-column:span 4;text-align:right;font-size:18px;margin-bottom:5px;"><button onclick="cA(7)">7</button><button onclick="cA(8)">8</button><button onclick="cA(9)">9</button><button onclick="cA(\\\'/\\\')">/</button><button onclick="cA(4)">4</button><button onclick="cA(5)">5</button><button onclick="cA(6)">6</button><button onclick="cA(\\\'*\\\')">*</button><button onclick="cA(1)">1</button><button onclick="cA(2)">2</button><button onclick="cA(3)">3</button><button onclick="cA(\\\'-\\\')">-</button><button onclick="cA(\\\'C\\\')">C</button><button onclick="cA(0)">0</button><button onclick="cE()">=</button><button onclick="cA(\\\'+(\\\')">+</button></div>';window.cA=v=>{let d=document.getElementById('c-d');if(v=='C')d.value='';else d.value+=v;};window.cE=()=>{let d=document.getElementById('c-d');try{d.value=eval(d.value)}catch{d.value='ERR'}};Kernel.createWindow('ABACUS',250,300,html,'win-calc');` },
                    "mines.js": { type: 'file', content: `let size=9,bombs=10,grid=[],gover=false;const html='<div style="background:#c0c0c0;padding:10px;text-align:center;height:100%;overflow:auto;"><div id="mine-msg" style="margin-bottom:5px;border:2px inset white;background:black;color:red;font-size:20px;">000</div><div id="mine-grid" style="display:grid;grid-template-columns:repeat(9,30px);gap:2px;background:#888;padding:2px;width:fit-content;margin:auto;"></div><button onclick="Mines.init()" style="margin-top:5px;">RESET</button></div>';window.Mines={init:function(){grid=[];gover=false;document.getElementById('mine-msg').innerText='PLAY';const g=document.getElementById('mine-grid');g.innerHTML='';for(let i=0;i<size*size;i++){grid[i]={b:false,r:false,f:false};const btn=document.createElement('div');btn.style.width='30px';btn.style.height='30px';btn.style.background='#ccc';btn.style.border='2px outset white';btn.style.cursor='pointer';btn.style.lineHeight='26px';btn.style.fontWeight='bold';btn.onclick=()=>Mines.click(i);btn.oncontextmenu=(e)=>{e.preventDefault();Mines.flag(i)};btn.id='m-'+i;g.appendChild(btn)}let bCount=0;while(bCount<bombs){let r=Math.floor(Math.random()*grid.length);if(!grid[r].b){grid[r].b=true;bCount++}}},click:function(i){if(gover||grid[i].f||grid[i].r)return;grid[i].r=true;const el=document.getElementById('m-'+i);el.style.border='1px dotted #888';el.style.background='#eee';if(grid[i].b){el.style.background='red';el.innerText='üí£';gover=true;document.getElementById('mine-msg').innerText='FAIL'}else{let c=Mines.count(i);if(c>0){el.innerText=c;el.style.color=['blue','green','red','purple'][c-1]||'black'}else{let q=[i];while(q.length){let curr=q.pop();let adj=Mines.getAdj(curr);adj.forEach(n=>{if(!grid[n].r&&!grid[n].b&&!grid[n].f){grid[n].r=true;let cel=document.getElementById('m-'+n);cel.style.border='1px dotted #888';cel.style.background='#eee';let cc=Mines.count(n);if(cc>0){cel.innerText=cc;cel.style.color=['blue','green','red','purple'][cc-1]||'black'}else q.push(n)}})}}}},flag:function(i){if(gover||grid[i].r)return;grid[i].f=!grid[i].f;document.getElementById('m-'+i).innerText=grid[i].f?'üö©':''},getAdj:function(i){let x=i%size,y=Math.floor(i/size),a=[];for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){if(dx==0&&dy==0)continue;let nx=x+dx,ny=y+dy;if(nx>=0&&nx<size&&ny>=0&&ny<size)a.push(ny*size+nx)}return a},count:function(i){return Mines.getAdj(i).filter(n=>grid[n].b).length}};Kernel.createWindow('MINES',330,420,html,'win-mines');Mines.init();` },
                    "synth.js": { type: 'file', content: `const ctx=new(window.AudioContext||window.webkitAudioContext);
                    let rec=null, chunks=[];
                    const html='<div style="background:#222;min-height:300px;display:flex;flex-direction:column;padding:10px;">' +
                    '<div style="display:flex; justify-content:space-between; margin-bottom:5px;">' +
                        '<div style="color:white;font-weight:bold;">SYNTH v2</div>' +
                        '<button id="rec-btn" onclick="Synth.toggleRec()" style="background:red;color:white;border:2px solid white;cursor:pointer;">‚óè REC</button>' +
                    '</div>' +
                    '<div style="flex:1;background:black;border:2px inset white;margin-bottom:10px;position:relative;"><canvas id="vis" width="280" height="100" style="width:100%;height:100%;"></canvas></div>' +
                    '<div style="display:flex;justify-content:center;gap:5px;flex-shrink:0;">'+['C4','D4','E4','F4','G4','A4','B4','C5'].map((n,i)=>'<button onmousedown="Synth.play('+(261.63*Math.pow(1.059463,[0,2,4,5,7,9,11,12][i]))+')" style="height:100px;width:40px;background:white;border-radius:0 0 5px 5px;cursor:pointer;">'+n+'</button>').join('')+'</div></div>';
                    
                    window.Synth={
                        dest: ctx.createMediaStreamDestination(),
                        toggleRec: function() {
                            const btn = document.getElementById('rec-btn');
                            if(rec && rec.state === 'recording') {
                                rec.stop();
                                btn.innerText = "‚óè REC";
                                btn.style.background = "red";
                            } else {
                                chunks = [];
                                let name = prompt("Filename:", "track.snd"); // Prompt here is tricky, let's use a default if null for silent mode or just keep prompt as it's user initiated logic
                                if(!name) name = "track.snd";
                                rec = new MediaRecorder(Synth.dest.stream);
                                rec.ondataavailable = e => chunks.push(e.data);
                                rec.onstop = e => {
                                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                                    const reader = new FileReader();
                                    reader.onload = function(evt) {
                                        BIO.saveFile('/home/' + (name.endsWith('.snd')?name:name+'.snd'), evt.target.result);
                                    };
                                    reader.readAsDataURL(blob);
                                };
                                rec.start();
                                btn.innerText = "‚ñ† STOP";
                                btn.style.background = "white";
                                btn.style.color = "red";
                            }
                        },
                        play:function(f){
                            if(ctx.state==='suspended')ctx.resume();
                            const o=ctx.createOscillator(),g=ctx.createGain();
                            o.type='sawtooth';
                            o.frequency.setValueAtTime(f,ctx.currentTime);
                            g.gain.setValueAtTime(0.2,ctx.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
                            o.connect(g);
                            g.connect(ctx.destination);
                            g.connect(Synth.dest); // Output to Recorder
                            o.start();
                            o.stop(ctx.currentTime+0.5);
                            const c=document.getElementById('vis');
                            if(c){
                                const cx=c.getContext('2d');
                                cx.fillStyle='rgba(0,0,0,0.2)';
                                cx.fillRect(0,0,c.width,c.height);
                                cx.fillStyle='#0f0';
                                cx.fillRect(Math.random()*c.width,Math.random()*c.height,20,20)
                            }
                        }
                    };
                    Kernel.createWindow('SYNTH',400,300,html,'win-synth');` 
                    },
                    "chronos.js": { type: 'file', content: `let startTime=0,elapsed=0,timerInt=null;const html='<div style="background:#333;color:#0f0;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:monospace;height:100%;"><div id="time-disp" style="font-size:40px;border:4px double #0f0;padding:10px;margin-bottom:20px;background:black;flex-shrink:0;">00:00.00</div><div style="flex-shrink:0;"><button onclick="Chronos.start()" style="padding:10px;font-weight:bold;color:green;">START</button> <button onclick="Chronos.stop()" style="padding:10px;font-weight:bold;color:red;">STOP</button> <button onclick="Chronos.reset()" style="padding:10px;font-weight:bold;">RESET</button></div><div id="laps" style="margin-top:10px;font-size:12px;flex-grow:1;width:80%;border-top:1px solid #555;overflow-y:auto;"></div></div>';window.Chronos={update:function(){const n=Date.now(),d=n-startTime+elapsed,ms=Math.floor((d%1000)/10),s=Math.floor((d/1000)%60),m=Math.floor((d/60000));document.getElementById('time-disp').innerText=(m<10?'0'+m:m)+':'+(s<10?'0'+s:s)+'.'+(ms<10?'0'+ms:ms)},start:function(){if(timerInt)return;startTime=Date.now();timerInt=setInterval(Chronos.update,10)},stop:function(){if(!timerInt)return;elapsed+=Date.now()-startTime;clearInterval(timerInt);timerInt=null;const d=document.createElement('div');d.innerText="LAP: "+document.getElementById('time-disp').innerText;document.getElementById('laps').prepend(d)},reset:function(){Chronos.stop();elapsed=0;document.getElementById('time-disp').innerText="00:00.00";document.getElementById('laps').innerHTML=""}};Kernel.createWindow('CHRONOS',300,300,html,'win-chronos');` },
                    "prism.js": { type: 'file', content: "Kernel.createWindow('PRISM',400,400,'<div style=\"background:black;color:#0f0;padding:20px\">PRISM ENCRYPTION SUITE<br>Drag image to encrypt.</div>');" },
                    "signal.js": { type: 'file', content: "const html='<div style=\"display:flex;height:100%;font-family:monospace;background:#111;\"><div style=\"width:140px;background:#222;border-right:1px solid #444;padding:5px;\"><div style=\"color:#fff;font-weight:bold;text-align:center;border-bottom:1px solid #444\">CONTACTS</div><div id=\"sig-contacts\"></div><button onclick=\"Signal.add()\" style=\"width:100%;margin-top:5px\">+ ADD</button></div><div style=\"flex:1;display:flex;flex-direction:column;\"><div id=\"sig-chat\" style=\"flex:1;overflow:auto;padding:10px;color:#ccc\"></div><div style=\"display:flex;padding:5px;background:#222\"><input id=\"sig-msg\" style=\"flex:1\"><button onclick=\"Signal.send()\">SEND</button></div></div></div>';window.Signal={init:function(){let u=prompt('Username:');if(u){const p=new Peer(u);p.on('open',i=>BIO.toast('Signal Online: '+i));p.on('connection',c=>{Signal.c=c;c.on('data',d=>document.getElementById('sig-chat').innerHTML+='<div>THEM: '+d+'</div>')})}},send:function(){const m=document.getElementById('sig-msg').value;if(Signal.c){Signal.c.send(m);document.getElementById('sig-chat').innerHTML+='<div>ME: '+m+'</div>'}}};Kernel.createWindow('SIGNAL',500,400,html,'win-sig');setTimeout(Signal.init,100);" },
                    "mesh.js": { type: 'file', content: "const html='<div style=\"background:#222;color:white;padding:10px;height:100%\"><b>MESH NETWORK</b><br>ID: <span id=\"m-id\">...</span><br><br><input id=\"m-target\" placeholder=\"Target ID\"><button onclick=\"Mesh.conn()\">CONNECT</button><div id=\"m-log\"></div></div>';window.Mesh={init:function(){let u=localStorage.getItem('divineOS_signal_user')||'anon'+Math.floor(Math.random()*999);const p=new Peer(u+'_net');p.on('open',i=>document.getElementById('m-id').innerText=i);p.on('connection',c=>{Mesh.c=c;c.on('data',d=>BIO.toast('MESH DATA: '+d))})},conn:function(){const t=document.getElementById('m-target').value;const c=new Peer().connect(t);c.on('open',()=>c.send('HELLO FROM MESH'))}};Kernel.createWindow('MESH',300,300,html,'win-mesh');setTimeout(Mesh.init,1000);" }
                }
            }
        }
    },
    
    resolve: function(path) {
        if(path === '/') return BIO.fs.root;
        const parts = path.split('/').filter(p => p);
        let curr = BIO.fs.root;
        for(let p of parts) {
            if(curr.type==='dir' && curr.content[p]) curr = curr.content[p];
            else if(curr[p]) curr = curr[p]; 
            else return null;
        }
        return curr.type === 'dir' ? curr.content : curr;
    },
    
    saveFile: function(path, content, isDir, silent) {
        if(!path) return;
        const parts = path.split('/').filter(p => p);
        const fileName = parts.pop();
        let curr = BIO.fs.root;
        
        for(let p of parts) {
            if(!curr[p]) curr[p] = { type: 'dir', content: {} };
            if(curr[p].type === 'dir') curr = curr[p].content;
            else if(curr[p]) curr = curr[p]; 
            else return;
        }
        
        if(isDir) curr[fileName] = { type: 'dir', content: {} };
        else curr[fileName] = { type: 'file', content: content };
        
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            localStorage.setItem('divineOS_disk', CryptoJS.AES.encrypt(str, BIO.masterKey).toString());
        }
        
        if(path === '/system/config.json') BIO.applyTheme();
        if(!silent && !isDir) BIO.toast("Saved: " + fileName);
        if(document.getElementById('win-manifest') && window.Manifest) Manifest.render(path.substring(0, path.lastIndexOf('/')) || '/');
    },
    
    deleteFile: function(path) {
        const parts = path.split('/').filter(p=>p);
        const name = parts.pop();
        let curr = BIO.fs.root;
        for(let p of parts) {
            if(curr.type==='dir' && curr.content[p]) curr = curr.content[p];
            else if(curr[p]) curr = curr[p]; 
            else return; 
        }
        if(curr.content && curr.content[name]) delete curr.content[name];
        else delete curr[name];
        
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            localStorage.setItem('divineOS_disk', CryptoJS.AES.encrypt(str, BIO.masterKey).toString());
        }
        BIO.toast("Deleted: " + name); 
        if(document.getElementById('win-manifest') && window.Manifest) Manifest.render(path.substring(0, path.lastIndexOf('/')) || '/');
    },
    
    factoryReset: function() {
        if(confirm("DESTROY DATA?")) {
            localStorage.removeItem('divineOS_disk');
            location.reload();
        }
    },
    applyTheme: function() {
        const file = BIO.resolve('/system/config.json');
        if(!file) return;
        try { const cfg = JSON.parse(file.content); for(let key in cfg.theme) document.documentElement.style.setProperty(key, cfg.theme[key]); } catch(e) {}
    },
    unlockSystem: function() {
        const pass = document.getElementById('boot-pass').value;
        if(!pass) return alert("KEY REQUIRED");
        BIO.masterKey = pass;
        BIO.reboot(true);
    },
    reboot: function(isUnlocked) {
        const saved = localStorage.getItem('divineOS_disk');
        
        if(saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            document.getElementById('auth-msg').innerText = "SYSTEM LOCKED // DECRYPT";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }
        if(!saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            document.getElementById('auth-msg').innerText = "NEW SYSTEM // CREATE KEY";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }

        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('bsod').style.display = 'none';
        document.getElementById('bios-screen').style.display = 'flex';
        document.getElementById('boot-log').innerHTML = '';
        
        delete window.Kernel;
        
        let step = 0;
        const steps = [
            () => BIO.log("BIOS: Memory OK"),
            () => {
                if(saved) {
                    try {
                        const bytes = CryptoJS.AES.decrypt(saved, BIO.masterKey);
                        const str = bytes.toString(CryptoJS.enc.Utf8);
                        if(!str) throw "WRONG_KEY";
                        BIO.fs = JSON.parse(str);
                        BIO.log("FS: Mounted.");
                    } catch(e) {
                        BIO.masterKey = null;
                        alert("ACCESS DENIED");
                        location.reload();
                        return;
                    }
                } else {
                    BIO.fs = JSON.parse(JSON.stringify(BIO.defaultFS));
                    BIO.log("FS: Initialized.");
                }
            },
            () => {
                const k = BIO.resolve('/system/kernel.js');
                if(!k) throw "KERNEL_MISSING";
                new Function(k.content)();
            },
            () => { BIO.applyTheme(); },
            () => {
                const b = BIO.resolve('/system/boot.js');
                if(!b) throw "BOOT_MISSING";
                new Function(b.content)();
            },
            () => {
                document.getElementById('bios-screen').style.display = 'none';
                document.getElementById('desktop').style.display = 'block';
                document.getElementById('taskbar').style.display = 'flex';
            }
        ];
        
        const tick = setInterval(() => {
            try {
                if(step < steps.length) { steps[step](); step++; }
                else clearInterval(tick);
            } catch(e) {
                clearInterval(tick);
                BIO.crash(e);
            }
        }, 300);
    },
    runScript: function(path) {
        const file = BIO.resolve(path);
        if(!file) return BIO.toast("FILE NOT FOUND: " + path);
        try {
            if(file.content.startsWith('data:image')) {
                Kernel.createWindow('VIEW', 400, 400, '<img src="'+file.content+'" style="width:100%">');
                return;
            }
            window._ARGS = null; const f = new Function(file.content); f();
        } catch(e) { BIO.toast("EXEC ERROR: " + e.message); }
    },
    editFile: function(path) {
        const file = BIO.resolve(path);
        if(!file) return BIO.toast("FILE NOT FOUND");
        const noteFile = BIO.resolve('/core/notepad.js');
        if(noteFile) { window._ARGS = { path: path, content: file.content }; new Function(noteFile.content)(); }
    },
    handleDrop: function(e) {
        e.preventDefault();
        document.getElementById('desktop').classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => BIO.saveFile('/home/'+file.name, evt.target.result);
            if(file.type.startsWith('image')) reader.readAsDataURL(file);
            else reader.readAsText(file);
        }
    }
};

window.onload = function() {
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    const d = document.body;
    d.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('desktop').classList.add('drag-over'); });
    d.addEventListener('dragleave', e => { e.preventDefault(); document.getElementById('desktop').classList.remove('drag-over'); });
    d.addEventListener('drop', BIO.handleDrop);
    BIO.reboot();
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
}
</script>
</body>
</html>
