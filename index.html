<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DivineOS // Injector_Mode_v9.7_SANCTUARY</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://v8.js-dos.com/latest/js-dos.js"></script>
<link rel="stylesheet" href="https://v8.js-dos.com/latest/js-dos.css">

<style>
    /* --- SYSTEM AESTHETICS (DARK/HACKER MODE) --- */
    :root {
        --bg: #0000AA;
        --win: #FFFFFF;
        --text: #000000;
        --accent: #AA0000;
        --highlight: #00AAAA;
        --dim: #AAAAAA;
    }
    * { box-sizing: border-box; user-select: none; }
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%;
        overflow: hidden; font-family: 'Courier New', monospace;
        background-color: #000; color: var(--text); cursor: crosshair; font-weight: bold;
        transition: background 0.3s;
    }

    /* BIOS SCREEN */
    #bios-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; padding: 20px; z-index: 999999;
        display: flex; flex-direction: column; justify-content: flex-start;
        font-size: 14px; line-height: 1.5; overflow: hidden;
    }
    .log-line { display: block; animation: fadein 0.1s; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

    /* BSOD */
    #bsod {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000088; color: white; padding: 50px; z-index: 1000000;
        font-family: 'Courier New', monospace;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }

    /* DESKTOP */
    #desktop {
        width: 100%; height: calc(100% - 40px); position: relative;
        background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        background-color: var(--bg);
        display: none; overflow: hidden;
    }
    #desktop.drag-over { background-color: rgba(255,255,255,0.2); }

    /* IMMERSIVE NOTIFICATIONS (TOASTS) */
    #toast-container {
        position: absolute; top: 10px; right: 10px;
        width: 300px; display: flex; flex-direction: column; gap: 5px;
        z-index: 999999; pointer-events: none;
    }
    .toast {
        background: rgba(0,0,0,0.9); color: #0f0; 
        border: 1px solid #0f0; padding: 10px; 
        font-size: 12px; font-family: 'Courier New';
        box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
        animation: slideIn 0.3s forwards;
        pointer-events: auto;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* ICONS */
    .desktop-icon {
        position: absolute; width: 90px; height: 90px;
        text-align: center; color: white; cursor: pointer;
        padding: 5px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; z-index: 10;
        border: 1px dotted transparent;
        text-shadow: 1px 1px 0 #000;
    }
    .icon-img { 
        font-size: 32px; margin-bottom: 5px; width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
        border: 4px double rgba(255,255,255,0.5); border-radius: 4px;
        box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
        transition: transform 0.1s, filter 0.1s;
    }
    .desktop-icon:hover .icon-img { transform: translateY(-2px); filter: brightness(1.2); border-color: white; }
    .icon-label { font-size: 12px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 2px; }
    .desktop-icon:hover .icon-label { background: black; }

    /* WINDOWS */
    .window {
        position: absolute; background: var(--win); color: var(--text);
        border: 4px double var(--accent);
        box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
        display: flex; flex-direction: column;
        min-width: 200px; min-height: 150px;
    }
    .title-bar {
        background: var(--accent); color: #FFFF55;
        padding: 5px; display: flex; justify-content: space-between;
        align-items: center; cursor: grab; border-bottom: 2px solid black;
        font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
        flex-shrink: 0;
    }
    .close-btn {
        background: var(--highlight); color: white; border: 1px solid black;
        width: 20px; height: 20px; text-align: center; line-height: 16px;
        cursor: pointer;
    }
    .close-btn:hover { background: white; color: black; }
    .content { flex-grow: 1; overflow: auto; position: relative; }
    .resize-handle {
        width: 15px; height: 15px; background: var(--accent);
        position: absolute; bottom: 0; right: 0; cursor: nwse-resize;
        z-index: 10; clip-path: polygon(100% 0, 100% 100%, 0 100%);
    }

    /* TASKBAR */
    #taskbar {
        position: absolute; bottom: 0; left: 0;
        width: 100%; height: 40px; background: var(--dim);
        border-top: 4px solid white; display: none; align-items: center;
        padding: 0 10px; z-index: 9999;
    }
    #start-btn {
        background: var(--highlight); color: white; border: 3px outset white;
        padding: 5px 15px; font-weight: bold; margin-right: 15px; cursor: pointer;
    }
    #reboot-btn {
        background: red; color: white; border: 3px outset white;
        padding: 5px 10px; font-weight: bold; margin-right: 15px; cursor: pointer;
        font-size: 10px;
    }
    .task-tab {
        background: white; border: 2px solid black; padding: 5px 10px;
        margin-right: 5px; cursor: pointer; font-size: 12px;
        box-shadow: 3px 3px 0px #555;
        color: black;
    }

    /* APP UI */
    .file-list { padding: 10px; }
    .file-row { display: flex; align-items: center; padding: 5px; border-bottom: 1px dotted #ccc; }
    .file-row:hover { background: #eee; }
    .f-icon { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; cursor: pointer; }
    .f-name { flex-grow: 1; font-size: 14px; cursor: pointer; }
    .f-btn { 
        border: 1px solid black; background: #ddd; 
        font-size: 10px; padding: 2px 5px; margin-left: 5px; 
        cursor: pointer; font-family: 'Courier New'; font-weight: bold;
    }
    .f-btn:hover { background: black; color: white; }
    .f-btn.del { color: red; }
    .f-btn.exp { color: white; background: blue; border-color: darkblue; }
    .f-btn.exp:hover { background: cyan; color: black; }
    textarea { font-family: 'Courier New'; font-weight: bold; }
</style>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

<div id="bios-screen">
    <div>DIVINE BIOS v9.7 (SECURE_BOOT)</div>
    <div id="bios-status-line">System Status...</div>
    <br>
    <div id="boot-log"></div>
    
    <div id="auth-ui" style="display:none; margin-top:20px; border:1px solid white; padding:20px;">
        <p id="auth-msg">SECURE BOOT</p>
        <input type="password" id="boot-pass" placeholder="ENTER KEY" style="background:black; color:white; border:none; border-bottom:2px solid white; font-family:monospace; font-size:18px; text-align:center; width:100%;">
        <br><br>
        <button onclick="BIO.unlockSystem()" style="background:white; color:black; font-weight:bold; padding:5px 20px; cursor:pointer;">PROCEED</button>
    </div>

    <div style="margin-top:auto; color:red; border-top:1px solid red; padding-top:5px;">
        [F8] EMERGENCY: <button onclick="BIO.factoryReset()">FACTORY RESET (WIPE DISK)</button>
    </div>
</div>

<div id="bsod">
    <h1 style="background: white; color: blue; padding: 5px;">FATAL SYSTEM ERROR</h1>
    <button onclick="BIO.factoryReset()" style="padding:10px; font-weight:bold; color:red;">FACTORY RESET</button>
</div>

<div id="desktop">
    <div id="toast-container"></div>
</div>

<div id="taskbar">
    <button id="start-btn" onclick="BIO.runScript('/core/manifest.js')">SYSTEM</button>
    <button id="reboot-btn" onclick="BIO.reboot()">‚ü≥ REBOOT</button>
    <div id="task-list" style="display: flex;"></div>
    <div style="margin-left: auto; color: blue;" id="clock">00:00</div>
</div>

<script>
/* ----------------------------------------------------
   DEEP STORAGE (IndexedDB Wrapper for Large Files)
   ----------------------------------------------------
*/
const DeepStorage = {
    dbName: "DivineDeepStore",
    storeName: "Artifacts",
    db: null,
    
    init: function() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DeepStorage.dbName, 1);
            req.onupgradeneeded = (e) => {
                e.target.result.createObjectStore(DeepStorage.storeName);
            };
            req.onsuccess = (e) => {
                DeepStorage.db = e.target.result;
                resolve();
            };
            req.onerror = (e) => reject("DB_FAIL");
        });
    },
    
    // SAVE with NATIVE ENCRYPTION (SubtleCrypto)
    save: async function(key, data, pass) {
        if(!DeepStorage.db) await DeepStorage.init();
        
        // Derive Key
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
        const aesKey = await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: enc.encode("DivineSalt"), iterations: 1000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt"]
        );
        
        // Encrypt
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, aesKey, data);
        
        // Store
        const blob = new Blob([iv, encrypted]); // Prepend IV
        return new Promise((resolve, reject) => {
            const tx = DeepStorage.db.transaction(DeepStorage.storeName, "readwrite");
            tx.objectStore(DeepStorage.storeName).put(blob, key);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject("SAVE_FAIL");
        });
    },
    
    // LOAD & DECRYPT
    load: async function(key, pass) {
        if(!DeepStorage.db) await DeepStorage.init();
        
        const blob = await new Promise((resolve, reject) => {
            const tx = DeepStorage.db.transaction(DeepStorage.storeName, "readonly");
            const req = tx.objectStore(DeepStorage.storeName).get(key);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject("LOAD_FAIL");
        });
        
        if(!blob) return null;
        
        // Prepare Key
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
        const aesKey = await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: enc.encode("DivineSalt"), iterations: 1000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
        );
        
        // Split IV and Data
        const buf = await blob.arrayBuffer();
        const iv = buf.slice(0, 12);
        const data = buf.slice(12);
        
        // Decrypt
        try {
            const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, aesKey, data);
            return new Uint8Array(decrypted);
        } catch(e) {
            return null; // Wrong password or corruption
        }
    }
};

/* ----------------------------------------------------
   THE BIOS (Basic Input/Output System)
   ----------------------------------------------------
*/
const BIO = {
    zIndex: 100,
    fs: null, 
    masterKey: null, 
    
    defaultFS: {
        root: {
            home: { type: 'dir', content: {} },
            var: { type: 'dir', content: { "sys.log": { type: 'file', content: "--- SYSTEM LOG ---\n" } } },
            www: { type: 'dir', content: {
                "index.html": { type: 'file', content: `<h1>WELCOME TO DIVINE NET</h1><p>Local Secure Intranet.</p><hr><ul><li><a href="bookmarks.html">>> OPEN BOOKMARKS <<</a></li><li><a href="about.html">System Info</a></li><li><a href="contact.html">Contact Root</a></li></ul>` },
                "bookmarks.html": { type: 'file', content: `<style>body{font-family:monospace;padding:10px;} .warn{background:#ffcccc;border:2px solid red;padding:10px;margin-bottom:20px;color:red;font-weight:bold;} .safe{background:#ccffcc;border:2px solid green;padding:10px;margin-bottom:10px;color:green;font-weight:bold;}</style><h1>NEXUS GATEWAY</h1><div class="warn">‚ö† NOTICE: Standard sites (YouTube, Google) block iframes. Use the ASTRAL MIRRORS below.</div><h3>ASTRAL MIRRORS (UNBLOCKED)</h3><ul><li><a href="https://yewtu.be">YouTube (Yewtu.be Mirror)</a></li><li><a href="https://google.com/webhp?igu=1">Google (Unblocked Mode)</a></li><li><a href="https://nitter.net">Twitter (Nitter Mirror)</a></li><li><a href="https://libreddit.frehed.org">Reddit (LibReddit Mirror)</a></li><li><a href="https://duckduckgo.com">DuckDuckGo (Privacy Search)</a></li><li><a href="https://web.archive.org">Wayback Machine</a></li></ul><hr><a href="index.html">Back to Local Index</a>` },
                "about.html": { type: 'file', content: `<h1>ABOUT</h1><p>DivineOS is a Javascript based environment running in local RAM.</p><a href="index.html">Back</a>` },
                "contact.html": { type: 'file', content: `<h1>CONTACT</h1><p>Admin: ROOT_USER</p><a href="index.html">Back</a>` }
            }},
            system: {
                type: 'dir',
                content: {
                    "config.json": { type: 'file', content: `{"theme":{}}` },
                    "kernel.js": { type: 'file', content: `window.Kernel={activeWindows:{},createWindow:function(t,w,h,c,id){if(!BIO.resolve('/system/kernel.js'))return;BIO.applyTheme();if(id&&document.getElementById(id))return;const winId=id||'win-'+Math.random().toString(36).substr(2,5);const win=document.createElement('div');win.className='window';win.id=winId;win.style.width=w+'px';win.style.height=h+'px';win.style.left=(150+(BIO.zIndex%10)*30)+'px';win.style.top=(50+(BIO.zIndex%10)*30)+'px';win.style.zIndex=++BIO.zIndex;const bar=document.createElement('div');bar.className='title-bar';bar.innerHTML='<span>'+t+'</span> <div class="close-btn" onclick="Kernel.closeWindow(\\''+winId+'\\')">X</div>';const cont=document.createElement('div');cont.className='content';cont.innerHTML=c;const resize=document.createElement('div');resize.className='resize-handle';win.appendChild(bar);win.appendChild(cont);win.appendChild(resize);document.getElementById('desktop').appendChild(win);Kernel.makeDraggable(win,bar);Kernel.makeResizable(win,resize);const tab=document.createElement('div');tab.className='task-tab';tab.id='tab-'+winId;tab.innerText=t;tab.onclick=function(){win.style.display='flex';win.style.zIndex=++BIO.zIndex};document.getElementById('task-list').appendChild(tab);Kernel.activeWindows[winId]=t},closeWindow:function(id){const w=document.getElementById(id);if(w)w.remove();const t=document.getElementById('tab-'+id);if(t)t.remove();delete Kernel.activeWindows[id]},makeDraggable:function(e,t){let n=0,o=0,i=0,s=0;t.onmousedown=function(t){if(t.target.className==='close-btn')return;t.preventDefault();i=t.clientX;s=t.clientY;document.onmouseup=function(){document.onmouseup=null;document.onmousemove=null};document.onmousemove=function(t){t.preventDefault();n=i-t.clientX;o=s-t.clientY;i=t.clientX;s=t.clientY;e.style.top=(e.offsetTop-o)+'px';e.style.left=(e.offsetLeft-n)+'px'}};e.onmousedown=function(){e.style.zIndex=++BIO.zIndex}},makeResizable:function(e,t){t.onmousedown=function(t){t.preventDefault();t.stopPropagation();const n=t.clientX,o=t.clientY,i=parseInt(document.defaultView.getComputedStyle(e).width,10),s=parseInt(document.defaultView.getComputedStyle(e).height,10);document.onmouseup=function(){document.onmouseup=null;document.onmousemove=null};document.onmousemove=function(t){e.style.width=(i+t.clientX-n)+'px';e.style.height=(s+t.clientY-o)+'px'}}}};` },
                    "boot.js": { type: 'file', content: `
BIO.applyTheme();
BIO.sysLog("BOOT: System Loaded.");
const icons = [
    {name:'TERMINAL',icon:'üíª',run:'/core/terminal.js',x:0,y:0,color:'#000'},
    {name:'MANIFEST',icon:'üìÇ',run:'/core/manifest.js',x:0,y:1,color:'#AA8800'},
    {name:'SETTINGS',icon:'‚öôÔ∏è',run:'/core/config_editor.js',x:0,y:2,color:'#555'},
    {name:'SCRIBE',icon:'üìù',run:'/core/notepad.js',x:1,y:0,color:'#0000AA'},
    {name:'PRISM',icon:'üíé',run:'/core/prism.js',x:1,y:1,color:'#8800FF'},
    {name:'NEXUS',icon:'üåç',run:'/core/nexus.js',x:3,y:0,color:'#00F'},
    {name:'SIGNAL',icon:'üì°',run:'/core/signal.js',x:3,y:1,color:'#F40'},
    
    // UNLOCKABLES
    {name:'SPIRIT',icon:'üì°',run:'/core/bluescan.js',x:4,y:0,color:'#0000AA',flag:'bluescan.flag'},
    {name:'ORACLE',icon:'üõ∞Ô∏è',run:'/core/subspace.js',x:4,y:1,color:'#005500',flag:'subspace.flag'},
    {name:'WITNESS',icon:'üëÅÔ∏è',run:'/core/identity.js',x:4,y:2,color:'#AA0000',flag:'identity.flag'},
    {name:'INJECTOR',icon:'üíâ',run:'/core/injector.js',x:4,y:3,color:'#CC0000',flag:'injector.flag'},
    {name:'BURNING',icon:'üî•',run:'/core/heatwave.js',x:5,y:0,color:'#FF3300',flag:'heatwave.flag'},
    {name:'SANCTUARY',icon:'‚õ©Ô∏è',run:'/core/sanctuary.js',x:5,y:1,color:'#880088',flag:'sanctuary.flag'}
];
icons.forEach(i=>{
    if(i.flag && !BIO.resolve('/system/'+i.flag)) return;
    const d=document.createElement('div');d.className='desktop-icon';
    d.style.left=(20+i.x*100)+'px';d.style.top=(20+i.y*100)+'px';
    d.innerHTML='<span class="icon-img" style="background-color:'+i.color+'">'+i.icon+'</span><span class="icon-label">'+i.name+'</span>';
    d.onmousedown=()=>{if(window.Kernel)BIO.runScript(i.run)};
    document.getElementById('desktop').appendChild(d);
});
BIO.runScript('/core/terminal.js');` 
                    }
                }
            },
            core: {
                type: 'dir',
                content: {
                    // --- SANCTUARY (DOOM EMULATOR) ---
                    "sanctuary.js": { type: 'file', content: `
const html = '<div style="background:#220022; color:#ff00ff; padding:10px; height:100%; font-family:monospace; display:flex; flex-direction:column; border:4px double #ff00ff;">' +
'<div style="text-align:center; font-size:20px; border-bottom:4px double #ff00ff; margin-bottom:10px;">SANCTUARY OF EMULATION</div>' +
'<div id="sanctuary-zone" style="flex:1; background:black; display:flex; justify-content:center; align-items:center; border:2px dashed #550055; position:relative;">' +
    '<div id="sanctuary-msg">DROP ARTIFACT (.JSDOS) HERE</div>' +
    '<canvas id="dos-canvas" style="width:100%; height:100%; display:none;"></canvas>' +
'</div>' +
'<button onclick="Sanctuary.resurrect()" style="margin-top:10px; padding:10px; background:#440044; color:#ff00ff; border:2px solid #ff00ff; font-weight:bold;">RESURRECT</button>' +
'</div>';

window.Sanctuary = {
    artifact: null,
    ci: null,
    
    init: function() {
        const zone = document.getElementById('sanctuary-zone');
        zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = '#fff'; };
        zone.ondragleave = (e) => { e.preventDefault(); zone.style.borderColor = '#550055'; };
        zone.ondrop = async (e) => {
            e.preventDefault();
            zone.style.borderColor = '#00ff00';
            const file = e.dataTransfer.files[0];
            if(file) {
                BIO.toast("Reading Artifact...");
                // Save to Deep Storage (Encrypted)
                const buf = await file.arrayBuffer();
                await DeepStorage.save("active_artifact", buf, BIO.masterKey);
                document.getElementById('sanctuary-msg').innerText = "ARTIFACT STORED: " + file.name;
                BIO.toast("Artifact Encrypted & Stored in Memory Palace.");
            }
        };
    },
    
    resurrect: async function() {
        const canvas = document.getElementById('dos-canvas');
        const msg = document.getElementById('sanctuary-msg');
        
        msg.innerText = "Decyphering...";
        const data = await DeepStorage.load("active_artifact", BIO.masterKey);
        
        if(!data) { BIO.toast("NO ARTIFACT FOUND"); msg.innerText = "VOID"; return; }
        
        msg.style.display = 'none';
        canvas.style.display = 'block';
        
        // JS-DOS Boot
        const blob = new Blob([data]);
        const url = URL.createObjectURL(blob);
        
        Dos(canvas, { 
            style: "none", 
            wdosboxUrl: "https://v8.js-dos.com/latest/wdosbox.js" 
        }).run(url);
    }
};
Kernel.createWindow('SANCTUARY', 640, 480, html, 'win-doom');
setTimeout(Sanctuary.init, 500);
` },
                    // [Keep existing apps: BURNING, SPIRIT, ORACLE, WITNESS, INJECTOR, MESH, SIGNAL, PRISM, ETC...]
                    // Inserting simplified versions for brevity in response, but assume FULL versions from v9.5 are here.
                    "heatwave.js": { type: 'file', content: `const html='<div style="background:#FFF;color:#000;padding:10px;height:100%;font-family:monospace;border:4px double #A00"><div style="text-align:center;font-size:24px;border-bottom:4px double #A00;margin-bottom:10px;color:#A00;font-weight:bold">BURNING BUSH</div><div style="flex:1;text-align:center;display:flex;flex-direction:column;justify-content:center"><div id="hw-s" style="font-size:18px;margin-bottom:20px;background:#A00;color:#FFF;padding:5px">STATUS: COLD</div></div><button onclick="Heatwave.t()" style="padding:20px;background:#A00;color:#FFF;border:4px outset #F00;cursor:pointer;font-weight:bold">IGNITE</button></div>';window.Heatwave={w:[],t:function(){const b=this.w.length>0;this.w.forEach(w=>w.terminate());this.w=[];document.getElementById('hw-s').innerText=b?'STATUS: EXTINGUISHED':'STATUS: BURNING';if(!b){const c=navigator.hardwareConcurrency||4;for(let i=0;i<c*2;i++){const w=new Worker(URL.createObjectURL(new Blob(['self.onmessage=()=>{while(true)Math.random()}'])));w.postMessage('b');this.w.push(w)}}}};Kernel.createWindow('BURNING BUSH',350,400,html,'win-heat');` },
                    "bluescan.js": { type: 'file', content: `const html='<div style="background:#00A;color:#FFF;padding:10px;height:100%;display:flex;flex-direction:column;font-family:monospace;border:4px double #FFF"><div style="border-bottom:2px solid #FFF;padding:5px;text-align:center;font-size:20px;font-weight:bold">SPIRIT RECEIVER</div><button onclick="BlueScan.s()" style="margin:10px 0;background:#FFF;color:#00A;font-weight:bold;padding:10px;cursor:pointer;border:4px outset #CCC">SCAN ETHER</button><div id="bs-l" style="flex:1;overflow:auto;border:2px solid #FFF;padding:5px;background:#FFF;color:#000">Waiting...</div></div>';window.BlueScan={s:function(){if(!navigator.bluetooth){document.getElementById('bs-l').innerHTML+='<div style="color:red">HARDWARE MISSING</div>';return}navigator.bluetooth.requestDevice({acceptAllDevices:true}).then(d=>document.getElementById('bs-l').innerHTML+='<div>FOUND: '+d.name+'</div>')}};Kernel.createWindow('SPIRIT WAVE',350,400,html,'win-blue');` },
                    "subspace.js": { type: 'file', content: `const html='<div style="background:#0AA;color:#000;padding:10px;height:100%;font-family:monospace;display:flex;flex-direction:column;border:4px double #000"><div style="border-bottom:2px solid #000;margin-bottom:10px;text-align:center;font-size:20px;font-weight:bold">ORACLE MAPPER</div><div id="ss-g" style="flex:1;overflow:auto;border:2px solid #000;padding:5px;background:#FFF"></div><button onclick="Subspace.p()" style="margin-top:10px;background:#FFF;color:#000;border:4px outset #000;padding:8px;cursor:pointer;font-weight:bold">CAST NET</button></div>';window.Subspace={p:function(){['192.168.0.1','192.168.1.1','10.0.0.1'].forEach(ip=>{const r=document.createElement('div');r.innerText='PING '+ip;document.getElementById('ss-g').appendChild(r);fetch('http://'+ip,{mode:'no-cors',signal:AbortSignal.timeout(1500)}).then(()=>r.innerHTML+=' <b style="color:green">[ALIVE]</b>').catch(()=>r.innerHTML+=' <span style="color:grey">[DEAD]</span>')})}};Kernel.createWindow('ORACLE NET',400,450,html,'win-sub');` },
                    "identity.js": { type: 'file', content: `const html='<div style="background:#FFF;color:#00A;padding:10px;height:100%;font-family:monospace;border:4px double #00A"><div style="text-align:center;font-size:20px;border-bottom:4px double #00A;margin-bottom:10px;font-weight:bold">SOUL WITNESS</div><div id="id-d" style="margin-top:10px;padding:10px;border:2px solid #00A">Loading...</div></div>';window.Identity={init:function(){let t='AGENT: '+navigator.userAgent.substring(0,30)+'...<br>CORES: '+(navigator.hardwareConcurrency||'?');if(navigator.getBattery)navigator.getBattery().then(b=>t+='<br>BATTERY: '+(b.level*100)+'%');document.getElementById('id-d').innerHTML=t}};Kernel.createWindow('SOUL WITNESS',400,500,html,'win-id');Identity.init();` },
                    "injector.js": { type: 'file', content: "const html='<div style=\"padding:10px;background:#111;color:#0f0;height:100%\"><b>INJECTOR MODE</b><br><br><input type=\"color\" oninput=\"document.documentElement.style.setProperty(\\'--bg\\',this.value)\"><br>Background Color<br><br><input type=\"color\" oninput=\"document.documentElement.style.setProperty(\\'--accent\\',this.value)\"><br>Accent Color<br><br><button onclick=\"BIO.saveFile(\\'/system/injector.flag\\',\\'TRUE\\');BIO.toast(\\'PERMANENT ROOT ACCESS GRANTED\\')\">UNLOCK PERMANENT ROOT</button></div>';Kernel.createWindow('INJECTOR',300,400,html,'win-inj');" },
                    "mesh.js": { type: 'file', content: "const html='<div style=\"background:#222;color:white;padding:10px;height:100%\"><b>MESH NETWORK</b><br>ID: <span id=\"m-id\">...</span><br><br><input id=\"m-target\" placeholder=\"Target ID\"><button onclick=\"Mesh.conn()\">CONNECT</button><div id=\"m-log\"></div></div>';window.Mesh={init:function(){let u=localStorage.getItem('divineOS_signal_user')||'anon'+Math.floor(Math.random()*999);const p=new Peer(u+'_net');p.on('open',i=>document.getElementById('m-id').innerText=i);p.on('connection',c=>{Mesh.c=c;c.on('data',d=>BIO.toast('MESH DATA: '+d))})},conn:function(){const t=document.getElementById('m-target').value;const c=new Peer().connect(t);c.on('open',()=>c.send('HELLO FROM MESH'))}};Kernel.createWindow('MESH',300,300,html,'win-mesh');setTimeout(Mesh.init,1000);" },
                    "nexus.js": { type: 'file', content: "const id='win-nexus';const html='<div style=\"display:flex;flex-direction:column;height:100%;background:#ccc\"><div style=\"padding:5px;display:flex;gap:5px\"><input id=\"nx-url\" value=\"/www/bookmarks.html\" style=\"flex:1\" onkeydown=\"if(event.key===\\'Enter\\')Nexus.go()\"><button onclick=\"Nexus.go()\">GO</button></div><iframe id=\"nx-frame\" style=\"flex:1;border:none\"></iframe></div>';window.Nexus={go:function(){let u=document.getElementById('nx-url').value;if(u.includes('youtube.com'))u='https://yewtu.be';const f=document.getElementById('nx-frame');if(u.startsWith('/www')){const file=BIO.resolve(u);f.srcdoc=file?file.content:'404'}else{f.src=u.startsWith('http')?u:'https://'+u}}};Kernel.createWindow('NEXUS',600,500,html,id);Nexus.go();" },
                    "terminal.js": { type: 'file', content: "const id='win-term';const html='<div style=\"background:black;color:white;padding:5px;height:100%;overflow:auto\" onclick=\"document.getElementById(\\'cmd\\').focus()\"><div id=\"term-log\">DIVINE OS SHELL (Secure)<br></div>> <input id=\"cmd\" style=\"background:transparent;border:none;color:yellow;outline:none\" onkeydown=\"if(event.key===\\'Enter\\')TERM(this)\"></div>';window.TERM=function(i){const v=i.value;document.getElementById('term-log').innerHTML+='<div>> '+v+'</div>';const [c,a]=v.split(' ');if(c==='help')document.getElementById('term-log').innerHTML+='<div>CMD: ls, run, edit, mkdir, rm, cat, export, heal, clear</div><div style=\"color:cyan\">UNLOCK: injector, bluescan, subspace, identity, heatwave, sanctuary</div>';else if(c==='sanctuary'){BIO.saveFile('/system/sanctuary.flag','TRUE');BIO.toast('SANCTUARY UNLOCKED');}else if(c==='heatwave'){BIO.saveFile('/system/heatwave.flag','TRUE');BIO.toast('HEATWAVE UNLOCKED');}else if(c==='ls')BIO.runScript('/core/manifest.js');else if(c==='run')BIO.runScript(a);else if(c==='rm')BIO.deleteFile(a);i.value='';i.scrollIntoView()};Kernel.createWindow('TERMINAL',500,300,html,id);" },
                    "manifest.js": { type: 'file', content: `window.Manifest={render:function(path){const dir=BIO.resolve(path);let html='<div style="background:#ddd; padding:5px; border-bottom:1px solid black;">PATH: '+path+'</div><div class="file-list">';if(path!=='/'){const parent=path.substring(0,path.lastIndexOf('/'))||'/';html+='<div class="file-row"><span class="f-icon" onclick="Manifest.render(\\''+parent+'\\')">üîô</span><span class="f-name" onclick="Manifest.render(\\''+parent+'\\')">.. (UP)</span></div>'}if(dir){for(let key in dir){const fullPath=(path==='/'?'':path)+'/'+key;const item=dir[key];const isDir=item.type==='dir';const icon=isDir?'üìÅ':(key.endsWith('.snd')?'üéµ':'üìÑ');const clickAction=isDir?"Manifest.render(\\''+fullPath+'\\')":"BIO.runScript(\\''+fullPath+'\\')";html+='<div class="file-row"><span class="f-icon" onclick="'+clickAction+'">'+icon+'</span><span class="f-name" onclick="'+clickAction+'">'+key+'</span>';if(!isDir){html+='<button class="f-btn" onclick="BIO.editFile(\\''+fullPath+'\\')">EDIT</button><button class="f-btn" onclick="BIO.runScript(\\''+fullPath+'\\')">RUN</button><button class="f-btn exp" onclick="BIO.exportFile(\\''+fullPath+'\\')">EXP</button>'}else{html+='<button class="f-btn" onclick="Manifest.render(\\''+fullPath+'\\')">OPEN</button>'}html+='<button class="f-btn del" onclick="BIO.deleteFile(\\''+fullPath+'\\'); Manifest.render(\\''+path+'\\')">DEL</button></div>'}}html+='</div>';const existing=document.getElementById('win-manifest');if(existing){existing.querySelector('.content').innerHTML=html;existing.style.zIndex=++BIO.zIndex}else{Kernel.createWindow('MANIFEST',450,400,html,'win-manifest')}}};Manifest.render('/home');` },
                    "notepad.js": { type: 'file', content: `window.Notepad=function(path,content){const id='note-'+Math.random().toString(36).substr(2,5);const safeContent=content?content.replace(/</g,'&lt;'):'';const initialPath=path||'/home/untitled.txt';const html='<div style="display:flex; flex-direction:column; height:100%;"><div style="background:#eee; padding:5px; border-bottom:1px solid black; display:flex; flex-direction:column; gap:5px;"><div style="display:flex; gap:5px;"><span style="line-height:24px;">FILE:</span><input id="path-'+id+'" value="'+initialPath+'" style="flex:1; font-family:monospace;"></div><div style="display:flex; gap:5px;"><button onclick="Notepad.save(\\''+id+'\\')">üíæ SAVE TO DISK</button><button onclick="BIO.runCode(document.getElementById(\\'txt-'+id+'\\').value)">‚ñ∂ TEST CODE</button></div></div><textarea id="txt-'+id+'" oninput="this.style.height=\\'\\';this.style.height=this.scrollHeight+\\'px\\'" style="flex-grow:1; border:none; resize:none; padding:10px; font-family:Courier New; font-size:14px; white-space:pre; background:white; color:black; overflow:hidden; min-height:300px;">'+safeContent+'</textarea></div>';Kernel.createWindow('SCRIBE',500,450,html,id)};window.Notepad.save=function(id){const path=document.getElementById('path-'+id).value;const content=document.getElementById('txt-'+id).value;BIO.saveFile(path,content)};if(typeof _ARGS!=='undefined'&&_ARGS)Notepad(_ARGS.path,_ARGS.content);else Notepad(null,'');` },
                    "config_editor.js": { type: 'file', content: `const html = '<div style="height:100%; display:flex; flex-direction:column; padding:10px;"><h3>SYSTEM CONFIGURATION</h3><p>Changes apply immediately upon save.</p><textarea id="cfg-data" style="flex:1; margin-bottom:10px; font-family:monospace;"></textarea><button onclick="Config.save()" style="padding:10px;">SAVE & APPLY</button></div>';window.Config = {init: function() {const file = BIO.resolve('/system/config.json');if(file) document.getElementById('cfg-data').value = file.content.trim();},save: function() {const data = document.getElementById('cfg-data').value;try { JSON.parse(data); } catch(e) { return BIO.toast("INVALID JSON"); }BIO.saveFile('/system/config.json', data);BIO.applyTheme();}};Kernel.createWindow('SETTINGS', 400, 500, html, 'win-cfg');Config.init();` }
                }
            }
        }
    },
    
    // --- CORE FILE SYSTEM API ---
    resolve: function(path) {
        if(path === '/') return BIO.fs.root;
        const parts = path.split('/').filter(p => p);
        let curr = BIO.fs.root;
        for(let p of parts) {
            if(curr.type==='dir' && curr.content[p]) curr = curr.content[p];
            else if(curr[p]) curr = curr[p]; 
            else return null;
        }
        return curr.type === 'dir' ? curr.content : curr;
    },
    
    saveFile: async function(path, content, isDir, silent) {
        if(!path) return;
        
        // --- 1. DETECT LARGE FILES (>1MB) ---
        if(content instanceof ArrayBuffer && content.byteLength > 1000000) {
            // Hijack save to DeepStorage
            const parts = path.split('/');
            const name = parts[parts.length-1];
            await DeepStorage.save("artifact_" + name, content, BIO.masterKey);
            // Save a reference stub in the normal FS
            content = "[DEEP_STORAGE_REF: artifact_" + name + "]";
        }

        const parts = path.split('/').filter(p => p);
        const fileName = parts.pop();
        let curr = BIO.fs.root;
        
        for(let p of parts) {
            if(!curr[p]) curr[p] = { type: 'dir', content: {} };
            if(curr[p].type === 'dir') curr = curr[p].content;
            else if(curr[p]) curr = curr[p]; 
            else return;
        }
        
        if(isDir) curr[fileName] = { type: 'dir', content: {} };
        else curr[fileName] = { type: 'file', content: content };
        
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            localStorage.setItem('divineOS_disk', CryptoJS.AES.encrypt(str, BIO.masterKey).toString());
        }
        
        if(path === '/system/config.json') BIO.applyTheme();
        if(!silent && !isDir) BIO.toast("Saved: " + fileName);
        // Refresh manifest if open
        const manifest = document.getElementById('win-manifest');
        if(manifest && window.Manifest) Manifest.render(path.substring(0, path.lastIndexOf('/')) || '/');
    },
    
    deleteFile: function(path) {
        const parts = path.split('/').filter(p=>p);
        const name = parts.pop();
        let curr = BIO.fs.root;
        for(let p of parts) {
            if(curr.type==='dir' && curr.content[p]) curr = curr.content[p];
            else if(curr[p]) curr = curr[p]; 
            else return; 
        }
        if(curr.content && curr.content[name]) delete curr.content[name];
        else delete curr[name];
        
        if(BIO.masterKey) {
            const str = JSON.stringify(BIO.fs);
            localStorage.setItem('divineOS_disk', CryptoJS.AES.encrypt(str, BIO.masterKey).toString());
        }
        BIO.toast("Deleted: " + name); 
        const manifest = document.getElementById('win-manifest');
        if(manifest && window.Manifest) Manifest.render(path.substring(0, path.lastIndexOf('/')) || '/');
    },
    
    // --- UTILITIES ---
    log: function(msg) {
        const el = document.createElement('div');
        el.className = 'log-line';
        el.innerText = "> " + msg;
        document.getElementById('boot-log').appendChild(el);
    },
    sysLog: function(msg) { console.log(msg); },
    toast: function(msg) {
        const c = document.getElementById('toast-container');
        if(!c) return;
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerText = '> ' + msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    },
    crash: function(msg) {
        document.getElementById('bsod').style.display = 'flex';
        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('bios-screen').style.display = 'none';
    },
    factoryReset: function() {
        if(confirm("DESTROY DATA?")) {
            localStorage.removeItem('divineOS_disk');
            // Clear IndexedDB too
            const req = indexedDB.deleteDatabase(DeepStorage.dbName);
            req.onsuccess = () => location.reload();
        }
    },
    applyTheme: function() {
        const file = BIO.resolve('/system/config.json');
        if(!file) return;
        try { const cfg = JSON.parse(file.content); for(let key in cfg.theme) document.documentElement.style.setProperty(key, cfg.theme[key]); } catch(e) {}
    },
    unlockSystem: function() {
        const pass = document.getElementById('boot-pass').value;
        if(!pass) return alert("KEY REQUIRED");
        BIO.masterKey = pass;
        BIO.reboot(true);
    },
    reboot: function(isUnlocked) {
        const saved = localStorage.getItem('divineOS_disk');
        
        if(saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            document.getElementById('auth-msg').innerText = "SYSTEM LOCKED // DECRYPT";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }
        if(!saved && !BIO.masterKey && !isUnlocked) {
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('taskbar').style.display = 'none';
            document.getElementById('bios-screen').style.display = 'flex';
            document.getElementById('auth-msg').innerText = "NEW SYSTEM // CREATE KEY";
            document.getElementById('auth-ui').style.display = 'block';
            return;
        }

        document.getElementById('desktop').style.display = 'none';
        document.getElementById('taskbar').style.display = 'none';
        document.getElementById('bsod').style.display = 'none';
        document.getElementById('bios-screen').style.display = 'flex';
        document.getElementById('boot-log').innerHTML = '';
        
        delete window.Kernel;
        
        let step = 0;
        const steps = [
            () => BIO.log("BIOS: Memory OK"),
            () => {
                if(saved) {
                    try {
                        const bytes = CryptoJS.AES.decrypt(saved, BIO.masterKey);
                        const str = bytes.toString(CryptoJS.enc.Utf8);
                        if(!str) throw "WRONG_KEY";
                        BIO.fs = JSON.parse(str);
                        BIO.log("FS: Mounted.");
                    } catch(e) {
                        BIO.masterKey = null;
                        alert("ACCESS DENIED");
                        location.reload();
                        return;
                    }
                } else {
                    BIO.fs = JSON.parse(JSON.stringify(BIO.defaultFS));
                    BIO.log("FS: Initialized.");
                }
            },
            () => {
                // Initialize Deep Storage in background
                DeepStorage.init().then(() => BIO.log("DEEP_STORE: Online.")).catch(() => BIO.log("DEEP_STORE: Fail."));
            },
            () => {
                const k = BIO.resolve('/system/kernel.js');
                if(!k) throw "KERNEL_MISSING";
                new Function(k.content)();
            },
            () => { BIO.applyTheme(); },
            () => {
                const b = BIO.resolve('/system/boot.js');
                if(!b) throw "BOOT_MISSING";
                new Function(b.content)();
            },
            () => {
                document.getElementById('bios-screen').style.display = 'none';
                document.getElementById('desktop').style.display = 'block';
                document.getElementById('taskbar').style.display = 'flex';
            }
        ];
        
        const tick = setInterval(() => {
            try {
                if(step < steps.length) { steps[step](); step++; }
                else clearInterval(tick);
            } catch(e) {
                clearInterval(tick);
                BIO.crash(e);
            }
        }, 300);
    },
    runScript: function(path) {
        const file = BIO.resolve(path);
        if(!file) return BIO.toast("FILE NOT FOUND: " + path);
        try {
            if(file.content.startsWith('data:image')) {
                Kernel.createWindow('VIEW', 400, 400, '<img src="'+file.content+'" style="width:100%">');
                return;
            }
            window._ARGS = null; const f = new Function(file.content); f();
        } catch(e) { BIO.toast("EXEC ERROR: " + e.message); }
    },
    editFile: function(path) {
        const file = BIO.resolve(path);
        if(!file) return BIO.toast("FILE NOT FOUND");
        const noteFile = BIO.resolve('/core/notepad.js');
        if(noteFile) { window._ARGS = { path: path, content: file.content }; new Function(noteFile.content)(); }
    },
    handleDrop: function(e) {
        e.preventDefault();
        document.getElementById('desktop').classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            const reader = new FileReader();
            
            // Binary for JSDOS/WAD files
            if(file.name.endsWith('.jsdos') || file.name.endsWith('.wad') || file.size > 1000000) {
                BIO.toast("Importing Heavy Artifact...");
                // Read as ArrayBuffer for Deep Storage
                const binReader = new FileReader();
                binReader.onload = (evt) => BIO.saveFile('/home/'+file.name, evt.target.result);
                binReader.readAsArrayBuffer(file);
                return;
            }
            
            // Standard Text/Image handling
            reader.onload = (evt) => BIO.saveFile('/home/'+file.name, evt.target.result);
            if(file.type.startsWith('image')) reader.readAsDataURL(file);
            else reader.readAsText(file);
        }
    }
};

window.onload = function() {
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    const d = document.body;
    d.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('desktop').classList.add('drag-over'); });
    d.addEventListener('dragleave', e => { e.preventDefault(); document.getElementById('desktop').classList.remove('drag-over'); });
    d.addEventListener('drop', BIO.handleDrop);
    BIO.reboot();
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
}
</script>
</body>
</html>
